#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass scrbook
\begin_preamble
\usepackage{listings}

\usepackage{a4wide}
\usepackage{balance}

\newcommand{\NSP}{\! \! \! \! \! \! \! \! }
\newcommand{\BNSP}{\NSP \NSP \NSP \NSP}
\newcommand{\DS}{\displaystyle}
\newcommand{\CL}{\centerline}

\usepackage{float}
\floatname{algorithm}{Equation Box}
%\renewcommand{\listofalgorithms}{ 
 % \begingroup 
  %  \listof{algorithm}{List of Equation Boxes} 
 % \endgroup 
%}


\date{}
% HEADERS
%\usepackage{fancyhdr}
%\lhead{\small{bfm-community.eu}}
%\rhead{\small{all rights reserved}} 

\usepackage{alltt}              %%  alltt for namelist
\usepackage{verbatim}   %%  alltt for namelist
% namelists
\newcommand{\NML} [1] {
\begin{alltt}
{\tiny \verbatiminput{./Namelists/#1.nml}}
\end{alltt}
  \vspace{-10pt}
}
\end_preamble
\use_default_options true
\begin_modules
eqs-within-sections
\end_modules
\maintain_unincluded_children false
\language american
\language_package default
\inputencoding auto
\fontencoding global
\font_roman "times" "default"
\font_sans "helvet" "default"
\font_typewriter "cmtl" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures true
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref true
\pdf_bookmarks true
\pdf_bookmarksnumbered false
\pdf_bookmarksopen false
\pdf_bookmarksopenlevel 1
\pdf_breaklinks false
\pdf_pdfborder false
\pdf_colorlinks false
\pdf_backref false
\pdf_pdfusetitle true
\papersize a4paper
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 0
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine natbib
\cite_engine_type authoryear
\biblio_style plainnat
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date true
\justification true
\use_refstyle 0
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\leftmargin 3cm
\topmargin 3cm
\rightmargin 3cm
\bottommargin 3cm
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 2
\papersides 2
\paperpagestyle headings
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
onecolumn 
\end_layout

\begin_layout Plain Layout


\backslash
begin{titlepage}
\end_layout

\end_inset


\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename ../logos/BFM-Consortium_members.png
	lyxscale 15
	scale 40

\end_inset


\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset CommandInset line
LatexCommand rule
offset "0cm"
width "15cm"
height "1pt"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace 1cm
\end_inset


\end_layout

\begin_layout Standard
\align center

\size giant
Coupling BFM with ocean models:
\begin_inset Newline newline
\end_inset


\begin_inset space ~
\end_inset


\begin_inset Newline newline
\end_inset


\size largest
the 1D Princeton Ocean Model
\end_layout

\begin_layout Standard
\begin_inset VSpace 1cm
\end_inset


\end_layout

\begin_layout Standard
\align center

\series bold
\emph on
M.
 Zavatarelli, N.
 Pinardi, G.
 Mussap, T.
 Lovato, C.
 Amadio, L.
 Mentaschi, M Butenschön, M.
 Vichi
\end_layout

\begin_layout Standard
\begin_inset VSpace 1cm
\end_inset


\end_layout

\begin_layout Standard
\align center
Release 1.1, February 2023
\begin_inset Newline newline
\end_inset

—– BFM Report series N.
 3 —–
\begin_inset Newline newline
\end_inset


\begin_inset space ~
\end_inset


\begin_inset Newline newline
\end_inset

http://bfm-community.eu
\emph on

\begin_inset Newline newline
\end_inset

bfm_st@cmcc.it
\end_layout

\begin_layout Standard
\noindent
\align center
\begin_inset CommandInset line
LatexCommand rule
offset "0cm"
width "15cm"
height "1pt"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace 4cm
\end_inset


\begin_inset space \hspace{}
\length 8cm
\end_inset


\begin_inset Graphics
	filename ../logos/BFM_Full_logo.png
	lyxscale 40
	width 50text%

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
end{titlepage}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Newpage clearpage
\end_inset


\end_layout

\begin_layout Quote
The BFM system team is gratefully indebted with Prof.
 George L.
 Mellor for allowing us to distribute the FORTRAN95 computer code of the
 one-dimensional Princeton Ocean Model that evolved from the original FORTRAN77
 version of the model.
\end_layout

\begin_layout Quote
This document should be cited as:
\begin_inset Newline newline
\end_inset

Zavatarelli M., Pinardi N., Mussap G., Lovato T., Amadio C., Mentaschi L., Butenschön
 M., Vichi M.
 (2023).
 Coupling BFM with Ocean models: the 1D Princeton Ocean Model.
 BFM Report series N.
 3, Release 1.1, June 2020, Bologna, Italy, http://bfm-community.eu, pp.
 58
\end_layout

\begin_layout Address

\size footnotesize
\begin_inset VSpace 13cm
\end_inset

Copyright 2020, The BFM System Team.
 This work is licensed under the Creative Commons Attribution-Noncommercial-No
 Derivative Works 2.5 License.
 To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-
nd/2.5/ or send a letter to Creative Commons, 171 Second Street, Suite 300,
 San Francisco, California, 94105, USA.

\size default
 
\end_layout

\begin_layout Standard
\begin_inset Newpage clearpage
\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset toc
LatexCommand tableofcontents

\end_inset


\end_layout

\begin_layout Chapter
Introduction
\end_layout

\begin_layout Standard
This report describes the online coupling between the one-dimensional version
 of the Princeton Ocean Model (hereafter POM1D), developed by 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

, and the Biogeochemical Flux Model (hereafter BFM), in term of the main
 equations and their translation into a computer code, and its code is distribut
ed with BFM (see details in http://bfm-community.eu).
 
\end_layout

\begin_layout Standard
The report is 
\lang british
organised
\lang american
 as follows:
\end_layout

\begin_layout Standard
Section 2 describes the governing equations and the boundary conditions
 used in the POM1D to simulate the ocean physical dynamics.
 A full description of biogeochemical equations is given in the BFM core
 manual 
\begin_inset CommandInset citation
LatexCommand citet
key "BFM-manual"
literal "true"

\end_inset

.
\end_layout

\begin_layout Standard
Section 3 is devoted to the description of the general characteristics of
 the BFM-POM1D coupling.
 The coupled equations and the relative boundary conditions are described
 along with the equation transformation coherent with the vertical coordinate
 system adopted.
 The section closes with an overview of the discretized equations and of
 the numerical technique and scheme used to solve them.
\end_layout

\begin_layout Standard
Section 4 provides detailed description and information of the BFM-POM1D
 computer code.
 The 
\family typewriter
main program
\family default
, the 
\family typewriter
module
\family default
s and the 
\family typewriter
subroutines
\family default
 composing the system are detailed with reference to the governing equations
 and information about practical use and specific implementation modifications
 are provided in order to facilitate the use.
\end_layout

\begin_layout Standard
Section 5 gives information about the installation of the modeling system,
 while section 6 shows results from simulation of the BFM-POM1D system implement
ed in the Gulf of Trieste.
 Initial conditions and forcing functions for such experiments are provided
 by the BFM site, so that an interested user can check its installation
 by replicating such results.
\end_layout

\begin_layout Standard

\end_layout

\begin_layout Chapter
POM1D physical model 
\begin_inset CommandInset label
LatexCommand label
name "chap:POM1Dmodel"

\end_inset


\end_layout

\begin_layout Section
General
\end_layout

\begin_layout Standard
POM1D is the one-dimensional version of the three dimensional Princeton
 Ocean Model, POM (
\begin_inset CommandInset citation
LatexCommand citealp
key "Blumberg-Mellor87"
literal "true"

\end_inset

), a primitive equation ocean circulation model formulated in sigma coordinates.
 Its prognostic state variables are the velocity, temperature, salinity
 and turbulent kinetic energy fields.
 Diffusivity is computed by mean of the second order turbulence closure
 scheme proposed by 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor-Yamada82"
literal "true"

\end_inset

.
 A full description of the original three dimensional model equations and
 the numerical scheme corresponding to the 1D implementation applied here,
 can be found in 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and in 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\end_layout

\begin_layout Section
The Governing equations
\begin_inset CommandInset label
LatexCommand label
name "subsec: POM-Governing-equations"

\end_inset


\end_layout

\begin_layout Standard
POM1D originates directly from a modification of the original three-dimensional
 model .
 The model adopts the hydrostatic and the Boussinesq approximation.
 The one-dimensional primitive equations and the equations for the physical
 tracers, written only for the 
\begin_inset Formula $z$
\end_inset

 (vertical space) and 
\begin_inset Formula $t$
\end_inset

 (time) independent variables are:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial\left(u,v\right)}{\partial t}\mp f\left(v,u\right)=\frac{\partial}{\partial z}\left[K_{M}\frac{\partial\left(u,v\right)}{\partial z}\right]+F_{u}\label{eq:UVeq}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\frac{\partial p}{\partial z}=-\rho g
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\frac{\partial w}{\partial z}=0
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial T}{\partial t}=\frac{\partial}{\partial z}\left(K_{H}\frac{\partial T}{\partial z}\right)+\Phi_{T}+F_{T}-\frac{\partial R}{\partial z}\label{eq:Teq}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial S}{\partial t}=\frac{\partial}{\partial z}\left(K_{H}\frac{\partial S}{\partial z}\right)+\Phi_{S}+F_{S}\label{eq:Seq}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial q_{2}}{\partial t}=\frac{\partial}{\partial z}\left(K_{H}\frac{\partial q_{2}}{\partial z}\right)+\frac{2g}{\rho_{0}}K_{H}\frac{\partial\widetilde{\rho}}{\partial z}-\frac{2q_{2}^{3}}{B_{1}l}+F_{q}\label{eq:Qeq}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial q_{2}l}{\partial t}=\frac{\partial}{\partial z}\left(K_{Q}\frac{\partial q_{2}l}{\partial z}\right)+\frac{lE_{1}g}{\rho_{0}}K_{H}\frac{\partial\widetilde{\rho}}{\partial z}-\frac{q_{2}^{3}}{B_{1}}\left\llbracket 1-\left\{ E_{2}\left[\frac{lH}{\kappa z\left(H+z\right)}\right]^{2}\right\} \right\rrbracket +F_{l}\label{eq:QLeq}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Where 
\begin_inset Formula $u$
\end_inset

, 
\begin_inset Formula $v$
\end_inset

 
\begin_inset Formula $\left(m/s\right)$
\end_inset

 are the mean velocity components; 
\begin_inset Formula $T$
\end_inset


\begin_inset Formula $\left(\text{ºC}\right)$
\end_inset

 and 
\begin_inset Formula $S$
\end_inset


\begin_inset Formula $\left(psu\right)$
\end_inset

 are the mean potential temperature and salinity vertical profiles; 
\begin_inset Formula $H$
\end_inset

 
\begin_inset Formula $\left(m\right)$
\end_inset

 is the bottom depth; 
\begin_inset Formula $f$
\end_inset

 is the Coriolis parameter; 
\begin_inset Formula $p$
\end_inset

 
\begin_inset Formula $\left(N/m^{2}\right)$
\end_inset

 is the pressure; 
\begin_inset Formula $\rho$
\end_inset

, 
\begin_inset Formula $\rho_{0}$
\end_inset

 
\begin_inset Formula $\left(kg/m^{3}\right)$
\end_inset

 are the instantaneous and reference seawater density respectively.
 The solar radiation, 
\begin_inset Formula $R$
\end_inset

 
\begin_inset Formula $\left(\text{ºC}m/s\right)$
\end_inset

, reaching the sea surface and penetrating the water column, is vertically
 attenuated following a double exponential decay relationship, parameterized
 according to 
\begin_inset CommandInset citation
LatexCommand citet
key "Paulson-Simpson77"
literal "true"

\end_inset

:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
R=\left(\varrho_{0}C_{p}\right)^{-1}Q_{s}\left[R_{p}e^{\frac{z}{\zeta_{1}}}+\left(1-R_{p}\right)e^{\frac{z}{\zeta_{2}}}\right]\label{eq:doubleExp-1}
\end{equation}

\end_inset

and is added to the heat equation 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Teq"

\end_inset

 as 
\begin_inset Formula $\partial R/\partial z$
\end_inset

 .
 In eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:doubleExp-1"

\end_inset

 
\begin_inset Formula $Q_{s}$
\end_inset

 is the surface solar radiation flux (
\begin_inset Formula $W/m^{2}$
\end_inset

), 
\begin_inset Formula $C_{p}$
\end_inset

 is the seawater specific heat, while the Radiance partition coefficient
 (
\begin_inset Formula $0\leq R_{p}\leq1$
\end_inset

) and the attenuation lengths (
\begin_inset Formula $\zeta_{1}$
\end_inset

and 
\begin_inset Formula $\zeta_{2}$
\end_inset

 in m) coefficients can be selected from the 
\begin_inset CommandInset citation
LatexCommand citet
key "Jerlov76"
literal "true"

\end_inset

 water (optical) types.
\end_layout

\begin_layout Standard
Twice the kinetic energy (
\begin_inset Formula $q_{2}$
\end_inset

), twice the kinetic energy times the turbulence length scale 
\begin_inset Formula $l$
\end_inset

 (
\begin_inset Formula $q_{2}l$
\end_inset

) and the turbulence vertical diffusivities 
\begin_inset Formula $K_{M}$
\end_inset

, 
\begin_inset Formula $K_{H}$
\end_inset

 and 
\begin_inset Formula $K_{Q}$
\end_inset

 
\begin_inset Formula $\left(m^{2}/s\right)$
\end_inset

 are provided by the 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor-Yamada82"
literal "true"

\end_inset

 2.5 turbulence closure scheme.
 In eqs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Qeq"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:QLeq"

\end_inset

 
\begin_inset Formula $B_{1}$
\end_inset

 
\begin_inset Formula $E_{1}$
\end_inset

 and 
\begin_inset Formula $E_{2}$
\end_inset

 are turbulence closure parameters (see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFQ"

\end_inset

); 
\begin_inset Formula $\kappa=0.4$
\end_inset

 is the von Karman constant and 
\begin_inset Formula $\partial\widetilde{\varrho}/\partial z=(\partial\rho/\partial z)-c_{s}^{-2}(\partial p/\partial z),$
\end_inset

with 
\begin_inset Formula $c_{s}=c_{s}(T,S)$
\end_inset

 being the speed of sound.
 
\begin_inset Formula $\Phi_{\left(T,S\right)}$
\end_inset

 are the terms that parameterize lateral advection of temperature and salinity
 (see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:LatAdv"

\end_inset

) 
\begin_inset Formula $F_{\left(u,v,q,l,T,S\right)},$
\end_inset

 parameterize unresolved diffusive processes.
 They are written likewise the turbulent diffusion terms:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
F_{\left(u,v,q\right)}=\frac{\partial}{\partial z}\left[\chi_{M}\frac{\partial\left(u,v,q\right)}{\partial z}\right]\label{eq:mdiffU}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
F_{l}=\frac{\partial}{\partial z}\left(\chi_{L}\frac{\partial q_{2}l}{\partial z}\right)\label{eq:mdiffL}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
F_{\left(T,S\right)}=\frac{\partial}{\partial z}\left[\chi_{\left(T,S\right)}\frac{\partial\left(T,S\right)}{\partial z}\right]\label{eq:mdiffT}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $\chi_{\left(M,l,T,S\right)}$
\end_inset

 
\begin_inset Formula $\left(m^{2}/s\right)$
\end_inset

 are background diffusion coefficients.
\end_layout

\begin_layout Section
The surface and bottom boundary conditions
\end_layout

\begin_layout Standard
The surface boundary conditions (applied at the depth of surface-most gridpoint,
 
\begin_inset Formula $z_{s}$
\end_inset

) for the momentum equations is the following:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{M}+\chi_{_{M}}\right)\frac{\partial\left(u,v\right)}{\partial z}\right]_{z=z_{s}}=\frac{\tau_{(x,y)}^{W}}{\rho_{0}}\label{eq:UBC}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
while those for 
\begin_inset Formula $q_{2}$
\end_inset

 and 
\begin_inset Formula $q_{2}l$
\end_inset

 are :
\begin_inset VSpace defskip
\end_inset


\begin_inset Formula 
\[
q_{2\mid z=z_{s}}=\left(B_{1}\right)^{\nicefrac{2}{3}}\left[\left(\frac{\tau_{(x)}^{W}}{\rho_{0}}\right)^{2}+\left(\frac{\tau_{(y)}^{W}}{\rho_{0}}\right)^{2}\right]
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q_{2}l\mid_{z=z_{s}}=0
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $\tau_{\left(x,y\right)}^{W}$
\end_inset

 
\begin_inset Formula $(N/m^{2})$
\end_inset

 are the (zonal and meridional) components of the wind stress.
 The wind stress field is an external forcing function to be provided to
 the model.
 
\end_layout

\begin_layout Standard
The momentum bottom boundary condition requires the computation of the bottom
 stress zonal and meridional components ( 
\begin_inset Formula $\tau_{\left(x,y\right)}^{B}$
\end_inset

).
 It is computed from the bottom current velocity (the velocity at the depth
 of the bottommost gridpoint, 
\begin_inset Formula $z_{b}$
\end_inset

):
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{M}+\chi_{_{M}}\right)\frac{\partial\left(u,v\right)}{\partial z}\right]_{z=z_{b}}=\frac{\tau_{\left(x,y\right)}^{B}}{\rho_{0}}=c_{z}\left\{ \left[u^{2}+v^{2}\right]^{0.5}\left(u,v\right)\right\} _{z=z_{b}}\label{eq:BBC}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $c_{z}$
\end_inset

 is a quadratic bottom drag coefficient computed according to:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
c_{z}=MAX\left\{ \frac{\kappa^{2}}{\left[ln\left(\frac{H-z_{b}}{z_{0}}\right)\right]^{2}},c_{z_{min}}\right\} \label{eq:BdragC}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $z_{0}$
\end_inset

 is the bottom roughness length 
\begin_inset Formula $\left(m\right)$
\end_inset

 and 
\begin_inset Formula $c_{z_{min}}$
\end_inset

 is the minimum achievable 
\begin_inset Formula $c_{z}$
\end_inset

 value.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The bottom boundary conditions for 
\begin_inset Formula $q_{2}$
\end_inset

 and 
\begin_inset Formula $q_{2}l$
\end_inset

 are :
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q_{2}\mid_{z=zb}=\left(B_{1}\right)^{\nicefrac{2}{3}}\left[\left(\frac{\tau_{(x)}^{B}}{\rho_{0}}\right)^{2}+\left(\frac{\tau_{(y)}^{B}}{\rho_{0}}\right)^{2}\right]^{0.5}
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
q_{2}l\mid_{z=zb}=0
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The surface boundary condition for temperature is:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{H}+\chi_{T}\right)\frac{\partial T}{\partial z}\right]_{z=z_{s}}=\left(\varrho_{0}C_{p}\right)^{-1}\left[\frac{\partial R}{\partial z}|_{z=z_{s}}-\left(Q_{b}+Q_{e}+Q_{h}\right)\right]\label{TBC}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $Q_{b}$
\end_inset

 is the net long wave radiation flux, 
\begin_inset Formula $Q_{e}$
\end_inset

 is the latent heat flux and 
\begin_inset Formula $Q_{h}$
\end_inset

 is the sensible heat flux; (all of them in 
\begin_inset Formula $W/m^{2}$
\end_inset

).
 
\end_layout

\begin_layout Standard
The salinity surface boundary conditions is defined by a 
\begin_inset Quotes eld
\end_inset

virtual
\begin_inset Quotes erd
\end_inset

 salinity flux obtained by relaxing the surface salinity value to a prescribed
 time varying value:
\begin_inset VSpace defskip
\end_inset

 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{H}+\chi_{S}\right)\frac{\partial S}{\partial z}\right]_{z=z_{s}}=\alpha\left[S^{*}(0,t)-S(0,t)\right]\label{eq:SBC}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $\alpha$
\end_inset

( 
\begin_inset Formula $m/s$
\end_inset

) is the relaxation velocity.
\end_layout

\begin_layout Standard
In alternative to the above surface boundary conditions for temperature
 and salinity, the POM1D code allows for prescribing a time varying surface
 temperature, 
\begin_inset Formula $T^{*}\left(0,t\right)$
\end_inset

 and salinity, 
\begin_inset Formula $S^{*}\left(0,t\right)$
\end_inset

 value:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[T(z_{s},t),S(z_{s},t)\right]=\left[T^{*}(0,t),S^{*}(0,t)\right]\label{eq:TSBC}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
At the ocean bottom an 
\begin_inset Quotes eld
\end_inset

adiabatic
\begin_inset Quotes erd
\end_inset

 boundary condition is applies:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{H}+\chi_{T,S}\right)\frac{\partial\left(T,S)\right)}{\partial z}\right]_{z=-H}=0\label{eq:BBC-1}
\end{equation}

\end_inset


\end_layout

\begin_layout Section
Diagnostic mode
\begin_inset CommandInset label
LatexCommand label
name "subsec:Diagnostic-mode"

\end_inset


\end_layout

\begin_layout Standard
POM1D structure has been modified (
\begin_inset CommandInset citation
LatexCommand citealp
key "Bianchi06"
literal "true"

\end_inset

, Mussap et al., 
\begin_inset CommandInset citation
LatexCommand citeyear
key "mussap1,mussap3"
literal "true"

\end_inset

, 
\begin_inset CommandInset citation
LatexCommand citealp
key "mussap2"
literal "true"

\end_inset

) in order to allow for the performance of diagnostic simulations, achieved
 by prescribing climatological observed time dependent temperature and salinity
 vertical profiles.
 The vertical turbulent diffusion coefficients profiles are then computed
 by the 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor-Yamada82"
literal "true"

\end_inset

 second order turbulent closure scheme on the basis of the prescribed (time
 varying) density vertical structure and of the wind dependent energy input.
 The coefficients are used to compute the time depending vertical profiles
 of the BFM state variables.
 The use of the ‘‘diagnostic’’ mode eliminates possible drifts in temperature
 and/or salinity due to the use of ‘‘non zero’’ surface heat and/or salinity
 surface fluxes or to the lack of a proper parametrisation of the lateral
 advective fluxes, which are, by construction, not contained in a one-dimensiona
l model implementation.
 The use of the diagnostic mode with climatological data, provides a stable
 (non-drifting) annual cycle of the vertical density structure, which is
 particularly suitable when using the numerical model to investigate the
 coupled marine ecosystem dynamics.
 Clearly, the reliability of the simulations is crucially dependent on the
 quality of the assembled climatology.
\end_layout

\begin_layout Chapter
BFM-POM1D physical biological coupling
\end_layout

\begin_layout Section
The vertical coordinate system and the vertical grid arrangement.
\begin_inset CommandInset label
LatexCommand label
name "subsec:The-vertical-coordinate-1-1"

\end_inset


\end_layout

\begin_layout Standard
The free surface 
\begin_inset Formula $(\eta)$
\end_inset

 three dimensional version of POM adopts a bottom following 
\begin_inset Quotes eld
\end_inset

sigma
\begin_inset Quotes erd
\end_inset

 vertical coordinate system: 
\begin_inset Formula $\sigma=\left(z-\eta\right)/\left(H+\eta\right)$
\end_inset

.
 In BFM-POM1D the vertical coordinate system reduces to a simple fractional
 coordinate system:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\sigma=\frac{z}{H}\label{eq:sigmalev-1-1}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
with 
\begin_inset Formula $-1\leq\sigma\leq0$
\end_inset

 between ocean bottom and surface respectively.
\end_layout

\begin_layout Standard
The computational grid is vertically staggered.
 The sigma coordinate position of all the variables computed by the modeling
 system is schematized in Fig.
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Vgrid-1-1"

\end_inset

.
 
\begin_inset Formula $T$
\end_inset

, 
\begin_inset Formula $S$
\end_inset

 
\begin_inset Formula $u$
\end_inset

, 
\begin_inset Formula $v$
\end_inset

, 
\begin_inset Formula $Q2$
\end_inset

, 
\begin_inset Formula $Q2L$
\end_inset

, are all the variables computed (prognostically and/or diagnostically)
 by POM1D (see section 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

).
 
\begin_inset Formula $C_{p}$
\end_inset

 represents all the pelagic (water column) prognostic LFGs and CFFs variables,
 whose biogeochemical rate of change 
\begin_inset Formula $\left(\partial C_{p}/\partial t\right)_{bgc}$
\end_inset

 (see eq.
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Phys+bgc"

\end_inset

) is computed by BFM.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename Figures/Vertical_grid_odf.png

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
The vertically staggered grid of BFM-POM1D.
 The picture reports also the computation location of the System state variables.
 The upper case 
\begin_inset Quotes eld
\end_inset

K
\begin_inset Quotes erd
\end_inset

 indexing refers to the computer code indexing, while the lower case 
\begin_inset Quotes eld
\end_inset

k
\begin_inset Quotes erd
\end_inset

 indexing refers to the notation used for the equations in discrete form
 reported in the text.
 
\begin_inset Formula $k_{m}$
\end_inset

 is the total number of model layers
\begin_inset CommandInset label
LatexCommand label
name "fig:Vgrid-1-1"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
The coupled equation for the biogeochemical state variables.
\begin_inset CommandInset label
LatexCommand label
name "sec:The-coupled-equation"

\end_inset


\end_layout

\begin_layout Subsection
The governing equations
\end_layout

\begin_layout Standard
The temporal total rate of change for a generic, pelagic (water column)
 non conservative BFM state LFG or CFF (
\begin_inset Formula $C_{p}$
\end_inset

) can be written as follows:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial C_{p}}{\partial t}=\frac{\partial C_{p}}{\partial t}\mid_{phys}+\frac{\partial C_{p}}{\partial t}\mid_{bgc}\label{eq:Phys+bgc}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where the first term of the equation right hand side, indicates the rate
 of change dependent on the physical processes (handled by the BFM-POM1D
 coupling), while the second term indicates the rate of change dependent
 on the biogeochemical processes (handled by BFM).
 Therefore the physical rate of change is solved by the equation for a non
 conservative state variable to which, for selected LFGs and CFFs (such
 as phytoplankton and particulate organic detritus), a vertical advection
 term, accounting for sinking, must be added.
 The coupled equation then is a typical 
\begin_inset Quotes eld
\end_inset

advection, diffusion, reaction
\begin_inset Quotes erd
\end_inset

 equation (i.e.
 an equation dealing with the time evolution of chemical or biological species
 in a flowing medium such as water or air, 
\begin_inset CommandInset citation
LatexCommand citealp
key "Hundsdorfer-Verwer03"
literal "true"

\end_inset

).
 and reads as:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial C_{p}}{\partial t}=\frac{\partial}{\partial z}\left[\left(K_{H}+\chi_{b}\right)\frac{\partial C_{p}}{\partial z}\right]+\frac{\partial\left(w_{s}C_{p}\right)}{\partial z}+\frac{\partial C_{p}}{\partial t}\mid_{bgc}\label{eq:GeneqBFM}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $\chi_{b}$
\end_inset


\begin_inset Formula $\left(m^{2}/s\right)$
\end_inset

 is the background diffusion coefficient and 
\begin_inset Formula $w_{s}(z,t)\leq0$
\end_inset

 
\begin_inset Formula $\left(m/s\right)$
\end_inset

 is a sinking velocity.
\end_layout

\begin_layout Standard
The BFM benthic state variables involved in the definition of the benthic-pelagi
c coupling are the dissolved and particulate detritus (
\begin_inset Formula $Q_{c,n,p}^{(1)}$
\end_inset

 and 
\begin_inset Formula $Q_{c,n,p,s}^{(6)}$
\end_inset

), whose temporal rates of change are described in the BFM core manual.
 These benthic state variables are physically connected with the pelagic
 coupled processes via the definition of the sedimentary particulate organic
 matter flux and the definition of the bottom boundary condition for the
 pelagic dissolved nutrients, as described in the following section.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsection
The surface and bottom boundary conditions
\begin_inset CommandInset label
LatexCommand label
name "subsec:The-BFMboundary-conditions"

\end_inset


\end_layout

\begin_layout Standard
The surface boundary conditions for all the BFM pelagic LFGs and CFFs state
 variables 
\begin_inset Formula $C_{p}$
\end_inset

 is a 
\begin_inset Quotes eld
\end_inset

zero flux
\begin_inset Quotes erd
\end_inset

 condition: 
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{M}+\chi_{_{b}}\right)\frac{\partial C_{p}}{\partial z}\right]_{z=z_{s}}=0\label{eq:NOSurflux}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
with the only, but very important, exception of the dissolved nutrients
 (phosphate, nitrate, ammonium and silicate) and dissolved gases (oxygen,
 
\begin_inset Formula $O_{2}$
\end_inset

 and carbon dioxide, 
\begin_inset Formula $CO_{2}$
\end_inset

) CFFs.
\end_layout

\begin_layout Standard
Concerning the inorganic nutrients, given the mainly coastal implementation
 of the BFM-POM1D system, it has been adopted a surface boundary condition
 defining a surface flux accounting for external (river-borne) nutrient
 input.
 The condition is defined by relaxing the prognostically computed surface
 nutrient (
\begin_inset Formula $N$
\end_inset

) concentration to a time varying observed surface value (
\begin_inset Formula $N^{*}$
\end_inset

):
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{M}+\chi_{_{b}}\right)\frac{\partial N}{\partial z}\right]_{z=z_{s}}=\gamma\left[N^{*}\left(t\right)-N\left(z_{s},t\right)\right]\label{eq:NutSurflux}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $\gamma$
\end_inset

 is a user specified relaxation velocity (
\begin_inset Formula $m/s$
\end_inset

).
\end_layout

\begin_layout Standard
The surface boundary condition for 
\begin_inset Formula $O_{2}$
\end_inset

 and 
\begin_inset Formula $CO_{2}$
\end_inset

 (
\begin_inset Formula $G$
\end_inset

) accounts for the ocean-atmosphere exchanges fluxes (
\begin_inset Formula $\varPhi_{BFM(G)})$
\end_inset

 in 
\begin_inset Formula $mmol\left(O_{2},CO_{2}\right)/\left(m^{2}s\right)$
\end_inset

 that are computed by a specific BFM procedure based on 
\begin_inset CommandInset citation
LatexCommand citet
key "Wanninkof92"
literal "true"

\end_inset

.
 The surface boundary condition for such BFM state variables is then:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{M}+\chi_{_{b}}\right)\frac{\partial G}{\partial z}\right]_{z=z_{s}}=\varPhi_{_{BFM(G)}}\label{eq:OSurflux}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $G$
\end_inset

 indicates the 
\begin_inset Formula $O_{2}$
\end_inset

 or 
\begin_inset Formula $CO_{2}$
\end_inset

 surface concentration.
\end_layout

\begin_layout Standard
At the ocean surface the sinking vertical velocity (see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:The-coupled-equation"

\end_inset

) is nil for all the BFM state variables:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
w_{s}(0,t)=0\label{eq:WSBC}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
At the ocean bottom, the benthic-pelagic coupling involves the burial of
 pelagic particulate organic matter (
\begin_inset Formula $R_{c,n,p,s}^{\left(6\right)}$
\end_inset

), and the phytoplankton functional types experiencing sinking (
\begin_inset Quotes eld
\end_inset

diatoms
\begin_inset Quotes erd
\end_inset

, 
\begin_inset Formula $P_{c,n,p,s}^{\left(1,\right)}$
\end_inset

 and 
\begin_inset Quotes eld
\end_inset

dinoflagellates
\begin_inset Quotes erd
\end_inset

, 
\begin_inset Formula $P_{c,n,p}^{\left(4\right)}$
\end_inset

 functional types) and the release toward the water column of dissolved
 inorganic nutrients.
 The benthic-pelagic coupling is then defined by the following bottom boundary
 conditions:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
w_{s}(-H,t)=w_{b}\label{eq:WBBC}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left(K_{H}+\chi_{b}\right)\frac{\partial\left(R_{c,n,p,s}^{\left(6\right)},P_{c,n,p,s}^{\left(1,4\right)}\right)}{\partial z}\mid_{z=z_{b}}=w_{b}\left[\left(R_{c,n,p,s}^{\left(6\right)},P_{c,n,p,s}^{\left(1,4\right)}\right)\Delta z^{-1}\right]_{z=z_{b}}\label{eq:burial flux}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\left[\left(K_{H}+\chi_{b}\right)\frac{\partial N}{\partial z}\right]_{z=z_{b}}=\frac{\mu_{Q_{n,p,s}^{(6)}}}{\Delta z\mid_{z=-H}}Q_{n,p,s}^{(6)}\label{eq:NBenPelF}
\end{equation}

\end_inset


\begin_inset CommandInset label
LatexCommand label
name "NBenPelFlux"

\end_inset


\end_layout

\begin_layout Standard
Note that the boundary condition 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NBenPelF"

\end_inset

 is handled by the BFM benthic closure scheme.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
The transformed equations
\end_layout

\begin_layout Standard
The adoption of a fractional (
\begin_inset Formula $\sigma)$
\end_inset

 vertical coordinate, requires recasting the governing equations into the
 new coordinate system.
 Posing 
\begin_inset Formula $t=t^{*}$
\end_inset

 and 
\begin_inset Formula $z=\sigma H$
\end_inset

 (refer to eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sigmalev-1-1"

\end_inset

).
 The relations (for a generic pelagic physical or biogeochemical state variable
 
\begin_inset Formula $C_{p}$
\end_inset

) linking the derivatives in the old and new systems are::
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\frac{\partial C_{p}}{\partial t}=\frac{\partial C_{p}}{\partial t^{*}}
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\frac{\partial C_{p}}{\partial z}=\frac{1}{H}\frac{\partial C_{p}}{\partial\sigma}
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The complete set of the physical biological coupled governing equations
 are then recasted in the new coordinate system as follows (the 
\begin_inset Formula $^{*}$
\end_inset

 is hereafter dropped for notational convenience): 
\end_layout

\begin_layout Standard
Momentum
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial\left(u,v\right)}{\partial t}\mp f\left(v,u\right)=\frac{1}{H^{2}}\frac{\partial}{\partial\sigma}\left(K_{M}+\chi_{M}\right)\frac{\partial\left(u,v\right)}{\partial\sigma}\label{eq:sigmaUV}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Potential temperature
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial T}{\partial t}=\frac{1}{H^{2}}\frac{\partial}{\partial\sigma}\left(K_{H}+\chi_{T}\right)\frac{\partial T}{\partial\sigma}+\Phi_{T}-\frac{1}{H}\frac{\partial R}{\partial\sigma}\label{eq:sigmaTemp}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Salinity:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial S}{\partial t}=\frac{1}{H^{2}}\frac{\partial}{\partial\sigma}\left(K_{H}+\chi_{S}\right)\frac{\partial S}{\partial\sigma}+\Phi_{S}\label{eq:sigmaS-1}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Hydrostaticity:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\frac{\partial p}{\partial\sigma}=-H\rho g
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Twice the kinetic energy:
\begin_inset Formula 
\begin{equation}
\frac{\partial q_{2}}{\partial t}=\frac{1}{H^{2}}\frac{\partial}{\partial\sigma}\left(K_{H}+\chi_{H}\right)\frac{\partial q_{2}}{\partial\sigma}+\frac{2g}{\rho_{0}}K_{H}\frac{1}{H}\frac{\partial\widetilde{\rho}}{\partial\sigma}-\frac{2q_{2}^{3}}{B_{1}l}\label{sigmaQ}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Twice the kinetic energy times the turbulence length scale:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial q_{2}l}{\partial t}=\frac{1}{H^{2}}\frac{\partial}{\partial\sigma}\left[(K_{Q}+\chi_{Q})\frac{\partial q_{2}l}{\partial\sigma}\right]+\frac{lE_{1}g}{\rho_{0}}(K_{H}+\chi_{H})\frac{1}{H}\frac{\partial\widetilde{\rho}}{\partial\sigma}-\frac{q_{2}^{3}}{B_{1}}\left\llbracket 1-\left\{ E_{2}\left[\frac{l}{\kappa\sigma H\left(1+\sigma\right)}\right]^{2}\right\} \right\rrbracket \label{eq:sigmaQL}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Generic dissolved or particulate (non sinking) BFM pelagic state variables:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\frac{\partial C_{p}}{\partial t}=\frac{1}{H^{2}}\frac{\partial}{\partial\sigma}\left(K_{H}+\chi_{S}\right)\frac{\partial C_{p}}{\partial\sigma}+\frac{\partial C_{p}}{\partial t}\mid_{bgc}
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Generic particulate (sinking) BFM pelagic state variables:
\begin_inset Formula 
\[
\frac{\partial C_{p}}{\partial t}=\frac{1}{H^{2}}\frac{\partial}{\partial\sigma}\left[\left(K_{H}+\chi_{b}\right)\frac{\partial C_{p}}{\partial\sigma}\right]+\frac{1}{H}\frac{\partial\left(w_{s}C_{p}\right)}{\partial\sigma}+\frac{\partial C_{p}}{\partial t}\mid_{bgc}
\]

\end_inset


\end_layout

\begin_layout Section
Information flow and numerical integration
\begin_inset CommandInset label
LatexCommand label
name "sec:Info&Integr"

\end_inset


\end_layout

\begin_layout Standard
The time evolution of physical variables is managed by the POM1D component
 of the modeling system and transferred to BFM.
 The information flow occurring between the model components of the system
 is schematized in Fig.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:informationflow"

\end_inset

.
 The physical variables are used to compute the diffusion and reaction terms
 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:GeneqBFM"

\end_inset

 and then combined to obtain the forward in time biogeochemical states.
 Red arrows indicate the external data (forcing functions) that are needed
 by the model in both the prognostic and diagnostic mode; blue arrows indicate
 additional data to be provided for the prognostic mode, while the green
 arrow indicates the prescribed, time varying, temperature and salinity
 vertical profiles, required by the diagnostic mode.
 The numerical integration method and scheme, used to compute the forward
 in time solution of all the BFM-POM1D state variables, is the same.
 The sensitivity of the BFM-POM1D to coupling technique and to integration
 schemes has been tested by 
\begin_inset CommandInset citation
LatexCommand citet
key "butenschoen12"
literal "true"

\end_inset

, and it was found that the source splitting (SoS) technique is more accurate.
 POM1D uses, for the active tracers, a time integration method based on
 SoS with a leapfrog scheme.
 The BFM-POM1D system carries out the final integration of the non-conservative
 tracers adopting the same coupling technique and numerical scheme.
 The leapfrog numerical scheme is adopted also for the integration in time
 of the benthic particulate organic matter (
\begin_inset Formula $Q_{c,n,p,s}^{(1,6)}$
\end_inset

).
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename Figures/coupling_structure.png
	lyxscale 30

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:informationflow"

\end_inset

Scheme of the information flow between the ocean model and the biogeochemical
 state variables.
 The red forcing arrows refer to the use in both the prognostic and diagnostic
 mode.
 The blue arrows refer to the use in the prognostic mode only while the
 green arrows refer to the use in diagnostic mode only.
 Numerical driver is a generic name for the source splitting solver used
 to advance in time the coupled solution of the BFM state variables, while
 the forward in time solution of the physical state variables in embedded
 in POM1D
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The numerical solution of all the BFM-POM1D state variables is carried out
 in two steps according to the SoS technique, involving an explicit and
 an implicit integration.
 The explicit leapfrog generate an intermediate solution.
 It might not be needed and, when needed, involves different equation terms
 in the specific equation.
 The characteristics of the (if needed) explicit leapfrog integration are
 given below by reporting the equation term in discrete form (refer to fig.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Vgrid-1-1"

\end_inset

).
 In the following 
\begin_inset Formula $n$
\end_inset

 is the time index, 
\begin_inset Formula $k$
\end_inset

 the vertical space index (from sea surface to bottom), 
\begin_inset Formula $\Delta Z_{k}$
\end_inset

 and 
\begin_inset Formula $\Delta ZZ_{k}$
\end_inset

 the vertical staggered grid fractional spacing.
 
\end_layout

\begin_layout Subsubsection*
Momentum
\end_layout

\begin_layout Standard
The intermediate velocity values 
\begin_inset Formula $(\widetilde{u},\widetilde{v})$
\end_inset

 are obtained by explicitly integrating the Coriolis terms in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sigmaUV"

\end_inset

:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{(\widetilde{u},\widetilde{v})^{k+\frac{1}{2}}-(u,v)_{n-1}^{k+\frac{1}{2}}}{2\Delta t}=\pm f(v,u)_{n}^{k+\frac{1}{2}}\label{eq:IntermedUV}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsubsection*
Conservative scalar properties (
\begin_inset Formula $T,$
\end_inset

 
\begin_inset Formula $S$
\end_inset

, 
\begin_inset Formula $q_{2}$
\end_inset

, 
\begin_inset Formula $q_{2}l$
\end_inset

)
\end_layout

\begin_layout Standard
No explicit integration is needed for 
\begin_inset Formula $q_{2}$
\end_inset

 and 
\begin_inset Formula $q_{2}l$
\end_inset

 needed.
 Then the intermediate values 
\begin_inset Formula $(\widetilde{q_{2}})$
\end_inset

 and 
\begin_inset Formula $\widetilde{q_{2}l}$
\end_inset

 are given by:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
(\widetilde{q_{2}},\widetilde{q_{2}l})^{k+\frac{1}{2}}=(q_{2},q_{2}l)_{n-1}^{k+\frac{1}{2}}
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

For temperature and salinity the intermediate values 
\begin_inset Formula $\widetilde{T}$
\end_inset

 and 
\begin_inset Formula $\tilde{S}$
\end_inset

 are given (for the prognostic mode only) by the forward in time integration
 of the lateral advective fluxes (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:LatAdv"

\end_inset

).
 The intermediate values are then given by:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{(\widetilde{T},\widetilde{S})^{k+\frac{1}{2}}-(T,S)_{n-1}^{k+\frac{1}{2}}}{2\Delta t}=(\Phi_{T},\Phi_{S})_{n}^{k+\frac{1}{2}}\label{eq:IntermedTS}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsubsection*
Dissolved and particulate (non sinking) pelagic BFM state variables
\end_layout

\begin_layout Standard
The intermediate value (
\begin_inset Formula $\widetilde{C_{p}}$
\end_inset

) is obtained by explicitly integrating the biogeochemical temporal rate
 of change:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\widetilde{C}_{p}^{k+\frac{1}{2}}-C_{p_{n-1}}^{k+\frac{1}{2}}}{2\Delta t}=\frac{\Delta C_{p_{n}}^{k+\frac{1}{2}}}{\Delta t}\mid_{bgc}\label{eq:explicitLF-nosink}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsubsection*
Particulate (sinking) pelagic BFM state variables
\end_layout

\begin_layout Standard
The intermediate value (
\begin_inset Formula $\widetilde{C_{p}}$
\end_inset

) is obtained by explicitly integrating the biogeochemical temporal rate
 of change and the advective (sinking) vertical flux, computed by applying
 an upwind discretisation:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\widetilde{C}_{p}^{k+\frac{1}{2}}-C_{p_{n-1}}^{k+\frac{1}{2}}}{2\Delta t}=\frac{1}{H}\frac{w_{s_{n}}^{k+1}\cdotp C_{p_{n}}^{k+\frac{1}{2}}-w_{s_{_{n}}}^{k}\cdotp C_{p_{n}}^{k-\frac{1}{2}}}{\Delta Z^{k}}+\frac{\Delta C_{p_{n}}^{k}}{\Delta t}\mid_{bgc}\label{eq:explicitLF-sink}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
All the intermediate values, above hereafter 
\begin_inset Formula $\widetilde{I}\equiv(\widetilde{u},\widetilde{v},\widetilde{T},\widetilde{S,}\widetilde{q_{2}},\widetilde{q_{2}l},$
\end_inset


\begin_inset Formula $\widetilde{C_{p}}$
\end_inset

), are then passed to an implicit Euler backward solver operating on 
\begin_inset Formula $2\Delta t$
\end_inset

 for the vertical diffusion:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{C_{n+1}^{k+\frac{1}{2}}-\widetilde{I}^{k+\frac{1}{2}}}{2\Delta t}=\frac{1}{H^{2}\Delta Z^{k}}\left[\left(K_{I}+\chi_{I}\right)_{n+1}^{k}\cdotp\left(\frac{C_{n+1}^{k-\frac{1}{2}}-C_{n+1}^{k+\frac{1}{2}}}{\Delta ZZ^{k-1}}\right)\right]-\left[\left(K_{I}+\chi_{I}\right)_{n+1}^{k+1}\cdotp\left(\frac{C_{n+1}^{k+\frac{1}{2}}-C_{n+1}^{k+\frac{3}{2}}}{\Delta ZZ^{k+1}}\right)\right]\label{eq:implicitLF}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $C\equiv(u,v,,T,S,q_{2},q2l,C_{p)}$
\end_inset

) 
\begin_inset Formula $K_{I}\equiv(K_{M},K_{H},K_{Q})$
\end_inset

 and
\begin_inset Formula $\chi_{I}\equiv(\chi_{M},\chi_{T},\chi_{S},\chi_{Q},\chi_{B})$
\end_inset


\end_layout

\begin_layout Standard
Note that:
\end_layout

\begin_layout Itemize
when computing potential temperature, eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:implicitLF"

\end_inset

 must be added of the term (in discrete form) accounting for solar radiation
 penetration, 
\begin_inset Formula $\left(\partial R/\partial\sigma\right)H^{-1}$
\end_inset

, in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sigmaTemp"

\end_inset

.
\end_layout

\begin_layout Itemize
when computing 
\begin_inset Formula $q_{2}$
\end_inset

 and 
\begin_inset Formula $q_{2}l$
\end_inset

, eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:implicitLF"

\end_inset

 must be added of the second and third terms (in discrete form) appearing
 in the right hand side of eqs, 
\begin_inset CommandInset ref
LatexCommand ref
reference "sigmaQ"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sigmaQL"

\end_inset

.
\end_layout

\begin_layout Standard
The discretisation and the integration of the equations accounting for the
 benthic-pelagic coupling is made trough an explicit leapfrog scheme.
 The equations discretisation is straightforward and, as an example, only
 the discrete form of benthic organic particulate detritus is given:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\frac{Q_{c,n,p,s_{n+1}}^{(6)}-Q_{c,n,p,s_{n-1}}^{(6)}}{2\Delta t}=-w_{b}\left(R_{c,n,p,s_{n}}^{\left(6\right)}+P_{c,n,p,s_{n}}^{\left(1,4\right)}\right)\mid_{z=-H}-\mu_{Q_{c,n,p,s}^{6}}Q_{c,n,p,s_{n}}^{(6)}\mid_{z=-H}
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
It is well known that in the leapfrog numerical integration scheme the solutions
 at odd and even time steps can diverge slowly.
 This time splitting is removed by a weak filter 
\begin_inset CommandInset citation
LatexCommand citep
key "Asselin72"
literal "true"

\end_inset

, applied to the pelagic and benthic (physical and biogeochemical) state
 variables, where the solution (
\begin_inset Formula $C_{n_{smoothed}}$
\end_inset

) is smoothed at each time step according to;
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
C_{n_{smoothed}}^{k}=C_{n}^{k}+0.5\upsilon\left(C_{n+1}^{k}-2C_{n}^{k}+C_{n-1}^{k}\right)\label{eq:Asselin}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $C_{n_{smoothed}}^{k}$
\end_inset

 is the smoothed (and final) solution and 
\begin_inset Formula $\upsilon$
\end_inset

 is a smoothing parameter (frequently set at 0.05).
\end_layout

\begin_layout Standard
Finally the time sequence is reset:
\end_layout

\begin_layout Standard
\begin_inset Formula $C_{n-1}^{k}=C_{n_{smoothed}}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $C_{n}^{k}=C_{n+1}^{k}$
\end_inset


\end_layout

\begin_layout Standard
and the iteration cycle starts anew.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The current implementation of the BFM-POM1D modeling system computes the
 biogeochemical rate of change with a synchronous time resolution with respect
 to the rates depending on physical processes.
 However, the coupling technique (as schematised in fig.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:SynAsynCoup"

\end_inset

) allows the use of a coarser resolution for the biogeochemical processes
 (
\begin_inset CommandInset citation
LatexCommand citealp
key "butenschoen12"
literal "true"

\end_inset

) at a time step 
\begin_inset Formula $\Delta\tau=m\Delta t$
\end_inset

 (with 
\begin_inset Formula $m=1,2,3.......$
\end_inset

).
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename Figures/coupling_source_splitting.png

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Source splitting coupling.
 Sinchronous coupling.
 b: Asynchronous coupling for the case 
\begin_inset Formula $\Delta\tau=2\Delta t$
\end_inset


\begin_inset CommandInset label
LatexCommand label
name "fig:SynAsynCoup"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Chapter
The computer code
\begin_inset CommandInset label
LatexCommand label
name "chap:The-computer-code"

\end_inset


\end_layout

\begin_layout Standard
The BFM site repository allows for the download of the complete BFM-POM1D
 computer code.
 Installation and generation instruction of the 
\begin_inset Quotes eld
\end_inset

root
\begin_inset Quotes erd
\end_inset

 directory instructions are provided in sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Installation"

\end_inset

 In the following 
\family typewriter
$BFMDIR
\family default
 indicate the system 
\begin_inset Quotes eld
\end_inset

root
\begin_inset Quotes erd
\end_inset

 directory.
\end_layout

\begin_layout Standard
The BFM-POM1D couling interface is located in the directory 
\family typewriter
$BFMDIR/src/pom 
\family default
that contains the 
\family typewriter
program main
\family default
 code driving the system (
\family typewriter
main_pombfm1d.F90
\family default
),the POM1D subroutines and modules or ocean physics (
\family typewriter
$BFMDIR/src/pom/phys
\family default
), and the soubroutines operating the coupling (
\family typewriter
$BFMdir/pom/coupling
\family default
).
 An example of the namelists needed for the modeling system parameterisation
 is provided in the BFM-POM1D test case.
\end_layout

\begin_layout Standard
The complete listing of the programs, routines and modules contained in
 the 
\family typewriter
phys
\family default
 and the 
\family typewriter
coupling
\family default
 directories is given is tab.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:CodesLIsting-1"

\end_inset

, along with the directory location and the corresponding filename.
 
\end_layout

\begin_layout Standard
In the following a description of the main characteristics of the 
\family typewriter
program main
\family default
 code, its associated 
\family typewriter
module
\family default
s, and of all the 
\family typewriter
subroutines
\family default
 is provided, with the aim to facilitate the implementation and use of the
 coupled modeling system.
\end_layout

\begin_layout Standard
\begin_inset Float table
placement th
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="25" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="4cm">
<column alignment="center" valignment="top" width="3cm">
<column alignment="center" valignment="top" width="4.5cm">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
\size footnotesize
Name
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
\size footnotesize
Directory 
\family typewriter
\series default
($BFMDIR/src/pom)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
\size footnotesize
Filename
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
Program MAIN
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
main_pombfm1d.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
\size footnotesize
Modules
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
POM
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
POMModule.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
CPL_VARIABLES
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_cpl_variables.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
Forcing
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_forcing.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
\size footnotesize
Subroutines
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
ADVERTE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_vert_integration.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
CALCDEPTH
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
calcdepth.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
DENS 
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
dens.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_env_forcing_1d 
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_env_forcing_1d.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
FORCING_MANAGER
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_forcing.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
load_restart
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_restart.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
get_init_TS_IC
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_get_init_TS_IC.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
scheme_benthic_lf1d
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_scheme_benthic_lf1d.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
opendat
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
opendat.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_bfm_1d
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_bfm_1d.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_dia_bfm
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_dia_bfm.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_ini_bfm
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_ini_bfm_1d.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_to_bfm
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_to_bfm.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
PROFQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
profq1d.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
PROF_TRACERS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
profTS.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
PROFUV
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
phys
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
profu.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
save_restart
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_restart.F90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
Routine vert_integration
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
coupling
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
\size footnotesize
pom_vert_integration.F90
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Listing of all the programs, subroutines and modules contained in BFM-POM1D
 interface, the directory pathway from the reference 
\family typewriter
$BFMDIR/src/pom
\family default
 and the corresponding filenames.
\begin_inset CommandInset label
LatexCommand label
name "tab:CodesLIsting-1"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Newpage clearpage
\end_inset


\end_layout

\begin_layout Section
Program 
\family typewriter
MAIN
\family default
 (
\family typewriter
main_pombfm1d.F90)
\begin_inset CommandInset label
LatexCommand label
name "sec:program-MAIN"

\end_inset


\end_layout

\begin_layout Standard
The 
\family typewriter
main
\family default
 program of the BFM-POM1D coupled system has been structured around the
 basis the POM1D 
\family typewriter
main
\family default
 program, to which have been added the calls to specific subroutines handling
 the BFM initial condition definition (or restart reading) and the execution
 of the BFM core.
\end_layout

\begin_layout Standard
A flow chart illustrating the structure of the main program is displayed
 in fig 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:MAIN-FlowChart"

\end_inset

.
 The blue boxes indicate model branching points or loop structure, while
 red boxes refer to specific routines called within the 
\family typewriter
main 
\family default
body.
 Black/grey boxes indicate non modular sections of code directly inserted
 into the 
\family typewriter
main
\family default
 body.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename Figures/coupling_workflow.png
	lyxscale 30
	width 95text%
	height 95theight%

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
The BFM-POM1D 
\family typewriter
main
\family default
 program flowchart.
\begin_inset CommandInset label
LatexCommand label
name "fig:MAIN-FlowChart"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\family typewriter
main
\family default
 program consist of two logical parts: the first part is the system initialisati
on procedure, where the model setup and the parameters relative to the specific
 problem treated are prepared.
 The second part is the time stepping loop, where the forward in time numerical
 integration is carried out via the index 
\family typewriter
intt
\family default
.
 In the following, these two logical parts are treated separately.
 A description of the general structure of the program with particular reference
 to the branching points and to the non modular code is provided, while
 the various subroutines are described in detail in dedicated sections of
 this report (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:BFM-POM1D-subroutines"

\end_inset

).
 
\end_layout

\begin_layout Subsection*
Initialisation
\end_layout

\begin_layout Standard
The reading of the namelist
\family typewriter
 params_POMBFM 
\family default
(sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

) provides the model with all the information needed for a general setup.
 Subsequently all the physical variables (contained in 
\family typewriter
mo
\family default
dule
\family typewriter
 POM
\family default
) are given a first initialisation by setting them to zero and the vertical
 coordinate system is finalised on the basis of the parameters 
\family typewriter
KL1
\family default
, 
\family typewriter
KL2
\family default
 and 
\family typewriter
KB
\family default
 (section 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

) trough subroutine
\family typewriter
 CALCDEPTH,
\family default
 sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:CALCDEPTH"

\end_inset

).
 At this stage the program computes also the value of the Coriolis parameter
 (
\family typewriter
COR
\family default
), the number of iterations needed to carry out an IDAYS simulation (
\family typewriter
IEND
\family default
) and twice the the time step 
\family typewriter
DT2
\family default
.
\end_layout

\begin_layout Standard
The value of the 
\family typewriter
ihotst 
\family default
(sec.
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

) parameter detemines the branch toward a 
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

 (from initial conditions) or a 
\begin_inset Quotes eld
\end_inset

hot
\begin_inset Quotes erd
\end_inset

 (from a restart file) start:
\end_layout

\begin_layout Itemize
If i
\family typewriter
hotst=0 
\family default
(
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

 start ), subroutine
\family typewriter
 get_init_TS_IC
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:get-TS-IC"

\end_inset

) is called.
 It handles the reading of the 
\begin_inset Formula $T$
\end_inset

 and 
\begin_inset Formula $S$
\end_inset

 initial conditions.
 Subsequently, the subroutine
\family typewriter
 DENS
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:DENS"

\end_inset

 is called in order to provide the initial density field.
\end_layout

\begin_layout Itemize
If
\family typewriter
 ihotst=1 
\family default
(
\begin_inset Quotes eld
\end_inset

hot
\begin_inset Quotes erd
\end_inset

 start) subroutine
\family typewriter
 load_restart 
\family default
(sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:load_restart"

\end_inset

) is called, handling the reading of the file needed to provide the restart
 conditions for POM1D.
 
\end_layout

\begin_layout Standard
The 
\family typewriter
main
\family default
 program flow converges towards the initialisation of the BFM state variables
 that is handled by subroutine
\family typewriter
 pom_ini_bfm_1d
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_ini_BFM"

\end_inset

), again on the basis of the 
\family typewriter
ihotst
\family default
 value.
 This ends the initialisation part.
\end_layout

\begin_layout Subsection*
Timestepping 
\end_layout

\begin_layout Standard
Once terminated the setup and initialisation phase, the time marching loop
 starts and proceeds across a number of iterations defined by the loop 
\family typewriter
intt=1, IEND.
 
\family default
The first operation iteratively carried out by the time marching loop, is
 the definition of the time varying forcing and (in case of a diagnostic
 simulation) of the prescribed data.
 Such operations are handled by the dedicated subroutine 
\family typewriter
Forcing_manager 
\family default
(sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:FORCING_MANAGER"

\end_inset

).
 
\end_layout

\begin_layout Standard
Immediately after 
\family typewriter
subroutine PROFQ
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFQ"

\end_inset

) is called.
 It contains the coding of the 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor-Yamada82"
literal "true"

\end_inset

 2.5 turbulence closure that outputs the vertical turbulent diffusion coefficient
 
\begin_inset Formula $K_{M}$
\end_inset


\begin_inset Formula $K_{H}$
\end_inset

 and 
\begin_inset Formula $K_{q}$
\end_inset

 to be used to compute the vertical distribution of all the state variables
 that are prognostically treated.
 The vertical 
\begin_inset Formula $T$
\end_inset

 and 
\begin_inset Formula $S$
\end_inset

 profiles are computed via the linear interpolation of the climatological
 data that occurs in subroutine
\family typewriter
 Forcing_manager
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:FORCING_MANAGER"

\end_inset

).
\end_layout

\begin_layout Standard
The computation of the Coriolis terms 
\begin_inset Formula $fu$
\end_inset

 and 
\begin_inset Formula $fv$
\end_inset

 appearing in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:UVeq"

\end_inset

 is carried out.
 The Coriolis terms are then used to compute (via explicit leapfrog integration)
 the intermediate, forward in time, 
\begin_inset Formula $\widetilde{u}$
\end_inset

 and 
\begin_inset Formula $\widetilde{v}$
\end_inset

 velocity profiles (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:IntermedUV"

\end_inset

), that are stored in the 
\family typewriter
UF
\family default
 and 
\family typewriter
VF
\family default
 arrays.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

              UF(:) = UB(:) + DT2 * COR * V(:) ! CORIOLIS TERM AND EXPLICIT
 LEAPFROG
\end_layout

\begin_layout Plain Layout

              VF(:) = VB(:) - DT2 * COR * U(:) ! CORIOLIS TERM AND EXPLICIT
 LEAPFROG
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The temporal update of the velocity profiles is then concluded by the sequential
 two calls to subroutine
\family typewriter
 PROFUV
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFUV"

\end_inset

).
 After these calls the computation of the physical state variables closes
 with the application of the 
\begin_inset CommandInset citation
LatexCommand citet
key "Asselin72"
literal "true"

\end_inset

 filter (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Asselin"

\end_inset

) and with the restoration of the time sequence for all the physical variables.
 Below it is shown the time sequence restoration for the temperature state,
 being identical for all the other state variables.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!     -----RESTORE TIME SEQUENCE----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

      TB(:) = T(:)
\end_layout

\begin_layout Plain Layout

      T(:)  = TF(:)
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Density is updated trough a call to 
\family typewriter
subroutine DENS
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:DENS"

\end_inset

).
\end_layout

\begin_layout Standard
The call to the 
\family typewriter
subroutine Pom_bfm_1d
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_bfm_1d"

\end_inset

) executes BFM, as well as the physical biological coupling and the SoS
 time integration of the BFM prognostic variables.
 This last call conclude the sequence of operations contained in the time
 marching loop, and the cycle starts anew.
 However, at a 
\family typewriter
savef 
\family default
frequency (see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:moduleService"

\end_inset

) the routine handling the output writing is called (
\family typewriter
subroutine pom_dia_bfm_id, 
\family default
sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_dia_bfm"

\end_inset

).
\end_layout

\begin_layout Section
Shared modules
\end_layout

\begin_layout Subsection
Module POM (
\family typewriter
phys/POMModule.F90
\family default
) 
\begin_inset CommandInset label
LatexCommand label
name "sec:modulePOM"

\end_inset


\end_layout

\begin_layout Standard
The description of the code must necessarily start with the 
\family typewriter
POM
\family default
 
\family typewriter
module
\family default
.
 Such module evolves from the original 
\family typewriter
include
\family default
 file 
\begin_inset Quotes eld
\end_inset


\family typewriter
comblk.h
\family default

\begin_inset Quotes erd
\end_inset

, defining, in many POM versions, the declaration of all the variables and
 parameters needed to run POM.
 The content of such 
\family typewriter
include
\family default
 file is now transferred into this module, to which several other parameters
 and/or variables have been added in order to facilitate the control of
 the model trough values provided via namelists (see secs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "namelist-pom_input"

\end_inset

).
 Here a brief description of the variables arrays and parameters (listed
 in alphabetical order) contained in the module is given.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: ALAT
\end_layout

\begin_layout Standard
latitude of the implementation site (
\begin_inset Formula $deg$
\end_inset

).
 
\family typewriter
ALAT
\family default
 is used for the computation of the Coriolis Parameter 
\family typewriter
COR
\family default
 (see below) in 
\family typewriter
program MAIN
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

).
 Value is provided via namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN) :: CBC 
\family default
(
\begin_inset Formula $c_{z}$
\end_inset

 in eq.
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:BdragC"

\end_inset

)
\end_layout

\begin_layout Standard
The bottom drag coefficient.
 It is computed in the initialisation section of 
\family typewriter
program main
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

).

\family typewriter
 
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN), Parameter :: CBCMIN=0.0025 (
\begin_inset Formula $c_{z_{min}}$
\end_inset

 
\family default
in eq.
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:BdragC"

\end_inset


\family typewriter
)
\end_layout

\begin_layout Standard
The minimum achievable value for the bottom drag coefficient.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: COR
\end_layout

\begin_layout Standard
Coriolis parameter 
\begin_inset Formula $f$
\end_inset

 (
\begin_inset Formula $s^{-1)}$
\end_inset

.
 Computed by 
\family typewriter
program MAIN
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) in initialisation section.
 Computation requires the 
\family typewriter
ALAT 
\family default
value.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN), Parameter :: DAYI=ONE/SEC_PER_DAY
\end_layout

\begin_layout Standard
One day in seconds (reciprocal.
 
\begin_inset Formula $s^{-1}$
\end_inset

).
 The 
\family typewriter
REAL (RLEN), Parameter ::
\family default
 
\family typewriter
ONE
\family default
 is contained in the BFM 
\family typewriter
module
\family default
 
\family typewriter
global_mem
\family default
.
 The 
\family typewriter
REAL(RLEN), parameter ::
\family default
 
\family typewriter
SEC_PER_DAY
\family default
 is contained in the BFM 
\family typewriter
module constants
\family default
.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: DTI
\end_layout

\begin_layout Standard
Model time step (
\begin_inset Formula $s$
\end_inset

).
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),public,dimension(KB) :: GM,GH,SM,SH,KN,SPROD,BPROD, A, C, VH,
 VHP, PROD,DTEF,D, DT
\end_layout

\begin_layout Standard
Service arrays used by the POM1D subroutines (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:BFM-POM1D-subroutines"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),parameter :: GRAV=9.806
\end_layout

\begin_layout Standard
Gravity (
\begin_inset Formula $m/s^{2}$
\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: H
\end_layout

\begin_layout Standard
The bottom depth (
\begin_inset Formula $m)$
\end_inset

.
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
 
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong) :: IDAYS
\end_layout

\begin_layout Standard
Length of the run (
\begin_inset Formula $days)$
\end_inset

.
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\end_layout

\begin_layout Standard

\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong) :: IEND
\end_layout

\begin_layout Standard
Number of iterations needed to cover an 
\begin_inset Quotes eld
\end_inset


\family typewriter
IDAYS
\family default

\begin_inset Quotes erd
\end_inset

 run.
 Computed by 
\family typewriter
program main
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) in initialisation section.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
i
\family typewriter
nteger(ilong) ::IHOTST
\end_layout

\begin_layout Standard
Switch for 
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

/
\begin_inset Quotes erd
\end_inset

hot
\begin_inset Quotes erd
\end_inset

 model starts.
 
\family typewriter
IHOTST=0
\family default
: 
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

 start from initial conditions; 
\family typewriter
IHOTST=1
\family default
: 
\begin_inset Quotes eld
\end_inset

hot
\begin_inset Quotes erd
\end_inset

 start from a restart file reading.
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong) :: intt
\end_layout

\begin_layout Standard
Counter of the time marching loop.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong),parameter :: KB=31
\end_layout

\begin_layout Standard
Total number of vertical layers.
 currently defined to 31.
 It must be user defined HERE.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong) :: KL1, KL2
\end_layout

\begin_layout Standard
Dummy arguments for the subroutine
\family typewriter
 CALCDEPTH
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:CALCDEPTH"

\end_inset

).
 
\family typewriter
KL1 and KL2
\family default
 are integers defining the number of surface
\family typewriter
 (KL1
\family default
) bottom (
\family typewriter
KL2
\family default
) vertical layers having a logarithmic distribution.
 The number of surface/bottom logaritmic layers are (respectively) 
\family typewriter
KL1-2
\family default
 and 
\family typewriter
KB-KL2-1
\family default
.
 Values are provided via namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),dimension(KB) ::KM,KH,KQ (
\begin_inset Formula $K_{M}$
\end_inset


\family default
,
\family typewriter
 
\begin_inset Formula $K_{H}$
\end_inset

 
\family default
and 
\begin_inset Formula $K_{q}$
\end_inset

 in equations 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:UVeq"

\end_inset

 to 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:QLeq"

\end_inset

).
\end_layout

\begin_layout Standard
The vertical diffusion coefficients vertical profiles (
\begin_inset Formula $m^{2}/s$
\end_inset

) for momentum (
\family typewriter
KM
\family default
), tracers (
\family typewriter
KH
\family default
) and kinetic energy (
\family typewriter
KQ
\family default
).
 They are computed according to 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor-Yamada82"
literal "true"

\end_inset

 in subroutine
\family typewriter
 PROFQ
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFQ"

\end_inset

).
 See also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),dimension(KB) :: L
\end_layout

\begin_layout Standard
The turbulence length scale vertical profile 
\begin_inset Formula $(m)$
\end_inset

 .
 The profile is prognostically computed according to 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor-Yamada82"
literal "true"

\end_inset

 in subroutine
\family typewriter
 PROFQ(
\family default
sec.

\family typewriter
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFQ"

\end_inset

).

\family default
 See also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong) :: NBCT, NBCS, NBCBFM
\end_layout

\begin_layout Standard
Flags to choose Temperature, Salinity and BFM tracers surface boundary condition
s (see eqs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "TBC"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:SBC"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:TSBC"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NOSurflux"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NutSurflux"

\end_inset

) in subroutine
\family typewriter
 PROF_TRACERS
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROF_TRACERS"

\end_inset

).
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
 
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: NRT 
\family default
(
\begin_inset Formula $\gamma$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NutSurflux"

\end_inset

).
\end_layout

\begin_layout Standard
Relaxation velocity (
\begin_inset Formula $m/day$
\end_inset

) for computation of surface nutrient flux (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NutSurflux"

\end_inset

 and sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:vert_integration"

\end_inset

).
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
 Conversion to (
\begin_inset Formula $m/s$
\end_inset

) is carried out automatically by the code.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong) :: NTP
\end_layout

\begin_layout Standard
Flag to choose 
\begin_inset CommandInset citation
LatexCommand citet
key "Jerlov76"
literal "true"

\end_inset

 water type in subroutine
\family typewriter
 PROF_TRACERS
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROF_TRACERS"

\end_inset

).
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),dimension(KB) :: Q2F,Q2,Q2B
\end_layout

\begin_layout Standard
Twice the turbulent kinetic energy vertical profiles (prognostically computed
 according to 
\begin_inset CommandInset citation
LatexCommand citealt
key "Mellor-Yamada82"
literal "true"

\end_inset

) at the three different time levels required by the leapfrog time integration
 scheme.
 
\family typewriter
Q2B=
\family default

\begin_inset Formula $Q2_{t-\Delta t}$
\end_inset

, 
\family typewriter
Q2=
\family default

\begin_inset Formula $Q2_{t}$
\end_inset

, 
\family typewriter
Q2F
\family default
=
\begin_inset Formula $Q2_{t+\Delta t}$
\end_inset

.
 The profiles are computed by subroutine
\family typewriter
 PROFQ (
\family default
sec.

\family typewriter
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFQ"

\end_inset

)
\family default
 See also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
r
\family typewriter
eal(RLEN),dimension(KB) :: Q2LF,Q2L,Q2LB
\end_layout

\begin_layout Standard
The kinetic energy (twice) times the turbulence length scale vertical profiles
 (prognostically computed according to 
\begin_inset CommandInset citation
LatexCommand citealt
key "Mellor-Yamada82"
literal "true"

\end_inset

) at the three different time levels required by the leapfrog time integration
 scheme.
 
\family typewriter
Q2LB=
\family default

\begin_inset Formula $Q2L_{t-\Delta t}$
\end_inset

, 
\family typewriter
Q2L=
\family default

\begin_inset Formula $Q2_{t}$
\end_inset

, 
\family typewriter
Q2LF
\family default
=
\begin_inset Formula $Q2_{t+\Delta t}$
\end_inset

.
 The profiles are computed by subroutine
\family typewriter
 PROFQ
\family default
 
\family typewriter
(
\family default
sec.
\family typewriter

\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFQ"

\end_inset

)
\family default
.
 See also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN), parameter :: RCP=4.187E6
\family default
 (
\begin_inset Formula $\rho_{0}C_{p}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "TBC"

\end_inset

)
\end_layout

\begin_layout Standard
Water specific heat times reference density.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),dimension(KB) :: RHO
\end_layout

\begin_layout Standard
The vertical density profile (
\begin_inset Formula $kg/m^{3}$
\end_inset

) computed from the vertical 
\begin_inset Formula $T$
\end_inset

 and 
\begin_inset Formula $S$
\end_inset

 profiles (and hydrostatic pressure) using an adaptation of the 
\begin_inset CommandInset citation
LatexCommand citet
key "UNESCO81"
literal "true"

\end_inset

 equation of state as in 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor91"
literal "true"

\end_inset

.
 Density computation is carried out in subroutine
\family typewriter
 DENS
\family default
.
 Note that 
\family typewriter
RHO
\family default
=
\begin_inset Formula $\left(\rho-\rho_{0}\right)10^{-3}$
\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN), parameter :: RHO0=1.0e3
\end_layout

\begin_layout Standard
A reference density (
\begin_inset Formula $kg/m^{3}$
\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN), parameter :: RHOSEA=RHO0 + 25.0
\end_layout

\begin_layout Standard
The seawater average density (
\begin_inset Formula $1025$
\end_inset

 
\begin_inset Formula $kg/m^{3}$
\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),dimension(KB) :: SF,S,SB
\end_layout

\begin_layout Standard
The vertical salinity (prognostically computed or diagnostically prescribed)
 profiles (
\begin_inset Formula $psu)$
\end_inset

 at the three different time levels required by the leapfrog time integration
 scheme.
 
\family typewriter
SB=
\family default

\begin_inset Formula $S_{t-\Delta t}$
\end_inset

, 
\family typewriter
S=
\family default

\begin_inset Formula $S_{t}$
\end_inset

, 
\family typewriter
SF
\family default
=
\begin_inset Formula $S_{t+\Delta t}$
\end_inset

.
 See eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Seq"

\end_inset

 and also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: SMOTH (
\begin_inset Formula $\upsilon$
\end_inset


\family default
in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Asselin"

\end_inset

)
\end_layout

\begin_layout Standard
Parameter for the 
\begin_inset CommandInset citation
LatexCommand citet
key "Asselin72"
literal "true"

\end_inset

 filter.
 Required when using a leapfrog integration scheme to link solutions computed
 at odd and even times.
 See also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: SSRT 
\family default
(
\begin_inset Formula $\alpha$
\end_inset

 in eq.
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:SBC"

\end_inset

).
\end_layout

\begin_layout Standard
Relaxation velocity (
\begin_inset Formula $m/day$
\end_inset

) for the surface salinity flux.
 conversion to 
\begin_inset Formula $m/s$
\end_inset

 is carried out automatically by the code.
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN) :: SWRAD 
\family default
[
\begin_inset Formula $(\rho_{0}C_{p})^{-1}Q_{s}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "TBC"

\end_inset

].
\end_layout

\begin_layout Standard
The short wave (solar) radiation at the sea surface 
\begin_inset Formula $\left(Km/s\right)$
\end_inset

.
 Note that the POM1D code requires 
\family typewriter
SWRAD
\family default
=
\begin_inset Formula $-\left[(\rho_{0}C_{p})^{-1}Q_{s}\right]$
\end_inset

 (a positive heat flux into the ocean has a negative value).
 When the model is run in diagnostic mode 
\family typewriter
SWRAD
\family default
 is used only to provide the solar radiation to the BFM component of the
 modelling system.
 The 
\family typewriter
SWRAD
\family default
 value is converted back to 
\begin_inset Formula $W/m^{2}$
\end_inset

 in subroutine
\family typewriter
 pom_to_bfm
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_to_bfm"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),dimension(KB) :: TF,T,TB
\end_layout

\begin_layout Standard
The vertical potential temperature (prognostically computed or diagnostically
 prescribed) profiles (
\begin_inset Formula $C^{o}$
\end_inset

) at the three different time levels required by the leapfrog time integration
 scheme.
 
\family typewriter
TB=
\family default

\begin_inset Formula $T_{t-\Delta t}$
\end_inset

, 
\family typewriter
T=
\family default

\begin_inset Formula $T_{t}$
\end_inset

, 
\family typewriter
TF
\family default
=
\begin_inset Formula $T_{t+\Delta t}$
\end_inset

.
 See eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Teq"

\end_inset

 and also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: TIME
\end_layout

\begin_layout Standard
Running time (
\begin_inset Formula $d$
\end_inset

).
 computed at each iteration in 
\family typewriter
program main
\family default
.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: TIME0
\end_layout

\begin_layout Standard
time at restart.
 
\family typewriter
IHOTST=0: TIME0=0.
 IHOTST=1: TIME0
\family default
 read from the restart file.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong) :: TRT, SRT 
\family default
(
\begin_inset Formula $\beta_{T}$
\end_inset

 and 
\begin_inset Formula $\beta_{S}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:LTS"

\end_inset

).
\end_layout

\begin_layout Standard
Relaxation times (
\begin_inset Formula $d)$
\end_inset

 for the definition of the lateral temperature and salinity fluxes (
\begin_inset Formula $\beta_{T}$
\end_inset

 and 
\begin_inset Formula $\beta_{S}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:LTS"

\end_inset

).
 Conversion to 
\begin_inset Formula $\left(s\right)$
\end_inset

 is operated automatically by the code.
 Value is provided trough namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN) :: TSURF, SSURF 
\family default
(
\begin_inset Formula $T^{*}$
\end_inset

 and 
\begin_inset Formula $S^{*}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:TSBC"

\end_inset

).

\family typewriter
 
\end_layout

\begin_layout Standard
The time varying prescribed surface temperature and salinity values.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),dimension(KB) :: UF,U,UB,VF,V,VB
\end_layout

\begin_layout Standard
The vertical horizontal velocity components profiles (
\begin_inset Formula $m/s$
\end_inset

) at the three different time levels required by the leapfrog time integration
 scheme.
 
\family typewriter
(UB,VB)=
\family default

\begin_inset Formula $\left(U,V\right)_{t-\Delta t}$
\end_inset

, 
\family typewriter
(U,V)=
\family default

\begin_inset Formula $(U,V)_{t}$
\end_inset

, 
\family typewriter
(UF,VF)
\family default
=
\begin_inset Formula $(U,V)_{t+\Delta t}$
\end_inset

.
 See eqs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:UVeq"

\end_inset

 and also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: UMOL 
\family default
(
\begin_inset Formula $\chi_{(M,L)}$
\end_inset

 in eqs.
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:mdiffU"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:mdiffL"

\end_inset

 respectively).
\end_layout

\begin_layout Standard
Background diffusion value (
\begin_inset Formula $m^{2}/s)$
\end_inset

 for the velocity (
\begin_inset Formula $u,v)$
\end_inset

 and the kinetic energy (
\begin_inset Formula $q2,q2l)$
\end_inset

 fields.
 Values are provided via namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: UMOLT,UMOLS,UMOLBFM 
\family default
(
\begin_inset Formula $\chi_{T}$
\end_inset

 in eq.
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:mdiffT"

\end_inset

, 
\begin_inset Formula $\chi_{S}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:mdiffS"

\end_inset

, and 
\begin_inset Formula $\chi_{B}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:GeneqBFM"

\end_inset

).
\end_layout

\begin_layout Standard
Background diffusion value (
\begin_inset Formula $m^{2}/s)$
\end_inset

 for the temperature (
\family typewriter
UMOLT
\family default
), salinity (
\family typewriter
UMOLS
\family default
) and the BFM (
\family typewriter
UMOLBFM
\family default
) fields .
 Values are provided via namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN) :: upperH
\family default
 (
\begin_inset Formula $z_{h}$
\end_inset

 in eq.
 )
\end_layout

\begin_layout Standard
Depth (
\begin_inset Formula $m$
\end_inset

) at which the lateral temperature and salinity fluxes start to modify the
 vertical profiles.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN), Parameter :: vonkarmann = 0.4 
\family default
(
\begin_inset Formula $\kappa$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:BdragC"

\end_inset

)
\end_layout

\begin_layout Standard
The von Karmann constant.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
r
\family typewriter
eal(RLEN) :: WUBOT,WVBOT
\end_layout

\begin_layout Standard
The bottom stress 
\begin_inset Formula $\left(m^{2}/s^{2}\right)$
\end_inset

 zonal (
\family typewriter
WUBOT
\family default
) and meridional (
\family typewriter
WVBOT
\family default
) components divided by a reference density.They are used to specify the
 momentum bottom boundary conditions.
 See eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:BBC"

\end_inset

.
 Computed in subroutine
\family typewriter
 PROFUV (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFUV"

\end_inset

).

\family default
 See also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN) :: WUSURF,WVSURF
\end_layout

\begin_layout Standard
The wind stress 
\begin_inset Formula $\left(m^{2}/s^{2}\right)$
\end_inset

 zonal (
\family typewriter
WUSURF
\family default
) and meridional (
\family typewriter
WVSURF
\family default
) components divided by a reference density .
 They are used to specify the momentum surface boundary conditions.
 see eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:UBC"

\end_inset

.
 Note that the POM1D code requires (
\family typewriter
WUSURF, WVSURF
\family default
)=
\begin_inset Formula $-\tau_{(x,y)}^{W}/\rho_{0}$
\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN) :: WSSURF (
\begin_inset Formula $\alpha\left[S^{*}\left(0,t\right)-S(0,t)\right]$
\end_inset

 
\family default
in eq.

\family typewriter
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:SBC"

\end_inset

)
\end_layout

\begin_layout Standard
The 
\begin_inset Quotes eld
\end_inset

virtual
\begin_inset Quotes erd
\end_inset

surface salinity flux 
\begin_inset Formula $\left(psu\cdot m/s\right)$
\end_inset

.
 see eq.
 It is used in subroutine
\family typewriter
 PROF_TRACERS
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROF_TRACERS"

\end_inset

, prognostic mode only) to specify the surface boundary condition for salinity
 note that 
\family typewriter
WSSURF=-(
\begin_inset Formula $\alpha\left[S^{*}\left(0,t\right)-S(0,t)\right]$
\end_inset


\family default
 : a salt flux into the ocean carries a negative sign.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN), dimension(KB):: WTADV, WSADV 
\family default
(
\begin_inset Formula $\Phi_{T}$
\end_inset

 and 
\begin_inset Formula $\Phi_{S}$
\end_inset

 in eqs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sigmaTemp"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sigmaS-1"

\end_inset

 respectively )
\end_layout

\begin_layout Standard
The temperature 
\begin_inset Formula $\left(C^{o}\cdot m/s\right)$
\end_inset

 and salinity 
\begin_inset Formula $\left(psu\cdot m/s\right)$
\end_inset

 lateral advective fluxes .
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN) ::WTSURF 
\family default

\begin_inset Formula $-(\rho_{0}C_{p})^{-1}\left(Q_{b}+Q_{e}+Q_{h}\right)$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "TBC"

\end_inset


\end_layout

\begin_layout Standard
The loss terms of the surface heat flux.
 Note that the POM1D code requires 
\family typewriter
WTSURF
\family default
=
\begin_inset Formula $-\left[-(\rho_{0}C_{p})^{-1}\left(Q_{b}+Q_{e}+Q_{h}\right)\right]$
\end_inset

 (a surface heat loss carries a positive sign).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),dimension(KB) :: Z,ZZ,DZ,DZZ,DZR
\end_layout

\begin_layout Standard
The arrays containing the vertically staggered coordinate system; sec.
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:The-vertical-coordinate-1-1"

\end_inset

.
 
\family typewriter
Z 
\family default
corresponds to 
\begin_inset Formula $\sigma$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sigmalev-1-1"

\end_inset

; 
\family typewriter
ZZ=(Z-0.5DZ);
\family default
 
\family typewriter
DZ
\begin_inset script subscript

\begin_layout Plain Layout
k
\end_layout

\end_inset

=Z
\begin_inset script subscript

\begin_layout Plain Layout
k
\end_layout

\end_inset

-Z
\begin_inset script subscript

\begin_layout Plain Layout

\family typewriter
k+1
\end_layout

\end_inset

; DZZ
\begin_inset script subscript

\begin_layout Plain Layout

\family typewriter
k
\end_layout

\end_inset

=ZZ
\begin_inset script subscript

\begin_layout Plain Layout

\family typewriter
k
\end_layout

\end_inset

-ZZ
\begin_inset script subscript

\begin_layout Plain Layout

\family typewriter
k+1
\end_layout

\end_inset

; DZR=(DZ)
\begin_inset script superscript

\begin_layout Plain Layout

\family typewriter
-1
\end_layout

\end_inset

.

\family default
 See also 
\begin_inset CommandInset citation
LatexCommand citet
key "Blumberg-Mellor87"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset

.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN), Parameter :: Z0B=0.01 
\family default
(
\begin_inset Formula $z_{0}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:BdragC"

\end_inset

)
\end_layout

\begin_layout Standard
The bottom roughness length 
\begin_inset Formula $\left(m\right)$
\end_inset

.
\end_layout

\begin_layout Subsection
Module CPL_VARIABLES (
\family typewriter
coupling/pom_cpl_variables.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "sec:moduleService"

\end_inset


\end_layout

\begin_layout Standard
This module (contained in the directory 
\family typewriter
$BFMdir/pom/coupling
\family default
 with the filename 
\family typewriter
pom_cpl_variables.F90)
\family default
 contains additional parameters, arrays and scalars necessary to accomplish
 the online direct coupling between POM1D and BFM.
 Also for this module a brief description of the content is given.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),public,dimension(KB-1) :: ISM
\end_layout

\begin_layout Standard
The time varying prescribed inorganic suspended matter concentration 
\begin_inset Formula $\left(mg/m^{3}\right)$
\end_inset

 vertical profile.
 it is computed via linear interpolation between time adjacent climatological
 values in subroutine
\family typewriter
 FORCING_MANAGER
\family default
 (
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:FORCING_MANAGER"

\end_inset

).
 It is used to compute the light vertical extinction coefficient in the
 BFM subroutine 
\family typewriter
CalcVerticalExtinction (
\family default
see 
\begin_inset CommandInset citation
LatexCommand citet
key "BFM-manual"
literal "false"

\end_inset

).
 
\family typewriter

\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong), Parameter :: SEC_IN_HOUR=3600
\end_layout

\begin_layout Standard
Seconds in one hour.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN) :: PO4SURF,NO3SURF,NH4SURF,SIO4SURF 
\family default
(
\begin_inset Formula $N^{*}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NutSurflux"

\end_inset

)
\end_layout

\begin_layout Standard
The surface nutrient (phosphate, nitrate, ammonia, silicate respectively)
 prescribed concentrations in 
\begin_inset Formula $mmol\left(P,N,Si\right)/m^{3}$
\end_inset

 needed to define the surface boundary condition for nutrients .
 
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
integer(ilong) :: savef
\end_layout

\begin_layout Standard
Frequency 
\begin_inset Formula $(days)$
\end_inset

 of the output averaging and writing.
 Selected variables will be averaged and written over a 
\family typewriter
savef
\family default
 ( sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

) timespan.
 
\end_layout

\begin_layout Standard
For output averaging and writing at daily frequency set: 
\family typewriter
savef=1
\end_layout

\begin_layout Standard
For output averaging and writing at monthly frequency set: 
\family typewriter
savef=30
\family default

\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
character(200) :: wind_input, surfaceS_input, radiance_input, ism_input,
 Sal_input, Temp_input, Sprofile_input, Tprofile_input, heat_input, surfNut_inpu
t, read_restart
\end_layout

\begin_layout Standard
These character variables contains the pathways to the initial condition
 and forcing data input.
 their content is provided via namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:BFM-POM1D-subroutines"

\end_inset

).
\end_layout

\begin_layout Subsection
Module Forcing 
\family typewriter
(coupling/pom_forcing.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:Module-Forcing"

\end_inset

 
\end_layout

\begin_layout Standard
This module contains all the definitions of arrays and scalars needed to
 read (and prepare for the time linear interpolation) the data needed to
 define the physical and biogeochemical model forcing.
 The module contains also the subroutine
\family typewriter
 FORCING_MANAGER
\family default
 (sec 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:FORCING_MANAGER"

\end_inset

), that manages the time dependent data and carries out the time linear
 interpolation.
\end_layout

\begin_layout Standard
The scalars and arrays contained in the module are the following:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
INTEGER(ilong),SAVE :: ICOUNTF, IFCHGE, IFINT
\end_layout

\begin_layout Standard
Counters for the linear interpolations.
 
\family typewriter
ICOUNTF
\family default
 counts the data 
\family typewriter
read
\family default
 statements.
 
\family typewriter
IFINT
\family default
 counts the model iterations.
 When 
\family typewriter
IFINT=IFCHGE
\family default
, new data need to be read.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),public,dimension(KB-1),SAVE :: ISM1,ISM2
\end_layout

\begin_layout Standard
The, adjacent in time, vertical profiles of inorganic suspended sediment
 (
\begin_inset Formula $mg/m^{3}).$
\end_inset

 It contributes to the definition of the PAR (Photosynthetically Available
 Radiation) vertical extinction coefficients.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL (RLEN),SAVE :: NO3_1,NO3_2 
\end_layout

\begin_layout Standard

\family typewriter
REAL (RLEN),SAVE :: PO4_1,PO4_2 
\end_layout

\begin_layout Standard

\family typewriter
REAL (RLEN),SAVE :: NH4_1,NH4_2 
\end_layout

\begin_layout Standard

\family typewriter
REAL (RLEN),SAVE :: SIO4_1,SIO4_2
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The, adjacent in time, surface concentration values of nitrate (NO3_# in
 
\begin_inset Formula $mmolN/m^{3}$
\end_inset

), phosphate (PO4_# in 
\begin_inset Formula $mmolP/m^{3}$
\end_inset

), ammonium (NH4_#, in 
\begin_inset Formula $mmolN/m^{3}$
\end_inset

) and silicate (SIO4_# in 
\begin_inset Formula $mmolSi/m^{3}$
\end_inset

).
 They contribute to the definition of the nutrients surface boundary condition.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN),SAVE :: RATIOF
\end_layout

\begin_layout Standard
Time linear interpolator.
 
\family typewriter
RATIOF=IFINT/IFCHGE
\family default

\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL(RLEN),SAVE :: SWRAD1,SWRAD2
\end_layout

\begin_layout Standard
The, adjacent in time, solar radiation data (
\begin_inset Formula $Q_{s}$
\end_inset

 in 
\begin_inset Formula $W/m^{2}$
\end_inset

).
 These data provide the total solar radiation (to be converted into Photosynthet
ically Available Radiation, PAR) to the BFM code describing primary production.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),public,dimension(KB),SAVE :: TCLIM1,TCLIM2 
\end_layout

\begin_layout Standard

\family typewriter
real(RLEN),public,dimension(KB),SAVE :: SCLIM1,SCLIM2
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The, adjacent in time, vertical temperature (
\family typewriter
TCLIM#
\family default
 in 
\begin_inset Formula $^{o}C$
\end_inset

) and salinity (
\family typewriter
SCLIM#
\family default
 in 
\begin_inset Formula $psu$
\end_inset

) profiles.
 They provide the full 
\begin_inset Formula $T$
\end_inset

 and 
\begin_inset Formula $S$
\end_inset

 profiles used by BFM-POM1D.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
REAL (RLEN),SAVE :: WSU1,WSU2,WSV1,WSV2
\end_layout

\begin_layout Standard
The, adjacent in time zonal (
\family typewriter
WSU#
\family default
) and meridional (
\family typewriter
WSV#
\family default
) components of the wind stress (
\begin_inset Formula $\tau_{\left(x,y\right)}^{W}$
\end_inset

 in 
\begin_inset Formula $N/m^{2})$
\end_inset

.
 These data are used in both modes.
\end_layout

\begin_layout Section
Subroutines for physics and coupling
\begin_inset CommandInset label
LatexCommand label
name "sec:BFM-POM1D-subroutines"

\end_inset


\end_layout

\begin_layout Standard
This section describes in detail all the subroutines and modules of the
 BFM-POM1D modeling system.
 as listed in Tab.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:CodesLIsting-1"

\end_inset

.
 The subroutines are alphabetically ordered.
\end_layout

\begin_layout Subsection
ADVERTE 
\family typewriter
(coupling/pom_vert_integration.F90)
\begin_inset CommandInset label
LatexCommand label
name "subsec:adverte"

\end_inset


\end_layout

\begin_layout Standard
This subroutine is called by subroutine 
\family typewriter
vert_integration 
\family default
(sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:vert_integration"

\end_inset

) and compute the sinking rate of change for the BFM particulate pelagic
 state variables (phytoplankton and particulate organic matter) that are
 subject to downward vertical advection (the second term in the left hand
 side of eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:GeneqBFM"

\end_inset

):
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{\partial C_{p}}{\partial t}\mid^{sinking}=\frac{\partial w_{s}C_{p}}{\partial z}\label{eq:sinking}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The subroutine dummy arguments are:
\end_layout

\begin_layout Standard

\family typewriter
F
\family default
: The sinking BFM state variable
\end_layout

\begin_layout Standard

\family typewriter
FDWDT:
\family default
 The output sinking flux
\end_layout

\begin_layout Standard

\family typewriter
W
\family default
: The sinking velocity
\end_layout

\begin_layout Standard
The discrete form of eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sinking"

\end_inset

 corresponds to the first term in the left hand side of eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:explicitLF-sink"

\end_inset


\end_layout

\begin_layout Standard
The surface and bottom boundary conditions are eqs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:WSBC"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:WBBC"

\end_inset

 respectively.
 The phytoplankton sinking velocity is time and space varying and is computed
 in the BFM subroutine handling the phytoplankton dynamics (subroutine
\family typewriter
 PhytoDynamics
\family default
; see 
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

).
 The particulate detritus constant sinking velocity is user defined trough
 the variable 
\family typewriter
p_rR6m
\family default
, whose value is set trough the BFM namelist
\family typewriter
 PelGlobal_parameters
\family default
.
 The burial velocity 
\begin_inset Formula $w_{b}$
\end_inset

 of eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:WBBC"

\end_inset

 for phytoplankton and particulate detritus are defined by the value of
 the variables 
\family typewriter
p_burvel_PI
\family default
 (phytoplankton) and 
\family typewriter
p_burvel_R6
\family default
 (particulate detritus) that can be set by the user in the BFM namelist
\family typewriter
 Settling_parameters.
\end_layout

\begin_layout Standard
The particulate material exiting the lower water column trough the water
 sediment interface flux 
\begin_inset Formula $\left(w_{b}C_{p}\right)_{z=-H}$
\end_inset

 enters the benthic compartment trough eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:burial flux"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsection
CALCDEPTH 
\family typewriter
(phys/calcdepth.F90)
\begin_inset CommandInset label
LatexCommand label
name "subsec:CALCDEPTH"

\end_inset


\end_layout

\begin_layout Standard
This subroutine established the vertical coordinate system (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:The-vertical-coordinate-1-1"

\end_inset

).
 The subroutine is called only once, when setting up the model, at the start
 of the 
\family typewriter
main
\family default
 program (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) Subroutine input (
\family typewriter
KB, KL1, KL2
\family default
) and output (
\family typewriter
Z, ZZ, DZ, DZZ
\family default
), are handled by the module
\family typewriter
 POM
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

).
\end_layout

\begin_layout Subsection
DENS
\family typewriter
 
\family default
(
\family typewriter
phys/dens.F90)
\begin_inset CommandInset label
LatexCommand label
name "subsec:DENS"

\end_inset


\end_layout

\begin_layout Standard
The subroutine compute the 
\begin_inset Quotes eld
\end_inset

in situ
\begin_inset Quotes erd
\end_inset

 density using the 
\begin_inset CommandInset citation
LatexCommand citet
key "UNESCO81"
literal "true"

\end_inset

 equation of state, as adapted by 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor91"
literal "true"

\end_inset

.
 The 
\begin_inset Quotes eld
\end_inset

in situ
\begin_inset Quotes erd
\end_inset

 density is determined as a function of salinity, potential temperature
 and pressure; the latter is approximated by the hydrostatic relation and
 constant density.
 The actual density is normalized on 
\begin_inset Formula $10^{3}kg/m^{3}$
\end_inset

.
 Since in subroutine 
\family typewriter
PROFQ
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFQ"

\end_inset

) only gradients are needed, the density value used is 
\family typewriter

\begin_inset Formula $RHO=(\rho-\rho_{0})10^{-3}$
\end_inset


\family default
 in order to reduce round-off error.
 Subroutine input 
\family typewriter
(T, S, ZZ, H, RHO0) 
\family default
and output (
\family typewriter
RHO
\family default
) are handled by module
\family typewriter
 POM
\family default
.
 (sec 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

).
 
\end_layout

\begin_layout Subsection
pom_env_forcing_1d
\family typewriter
 
\family default
(
\family typewriter
coupling/pom_env_forcing_1d.F90)
\begin_inset CommandInset label
LatexCommand label
name "subsec:env_forcing_pom_bfm_1"

\end_inset


\end_layout

\begin_layout Standard
This subroutine is called from 
\family typewriter
subroutine pom_bfm_1d
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_bfm_1d"

\end_inset

) and handles the calling of all the subroutines that provides BFM with
 all the needed information about the physical environment: 
\end_layout

\begin_layout Standard

\family typewriter
subroutine pom_to_bfm
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_to_bfm"

\end_inset

): Transfers the POM1D state variables into the correspondent BFM's.
 
\end_layout

\begin_layout Standard

\family typewriter
subroutine CalcVerticalExtinction
\family default
 .
 It is a BFM subroutine, see 
\begin_inset CommandInset citation
LatexCommand citet
key "BFM-manual"
literal "true"

\end_inset

.
 Computes the 
\begin_inset Formula $z$
\end_inset

 dependent light vertical extinction coefficients.
 
\end_layout

\begin_layout Standard

\family typewriter
subroutine CalcLightDistribution.

\family default
 It is a BFM subroutine, see 
\begin_inset CommandInset citation
LatexCommand citet
key "BFM-manual"
literal "true"

\end_inset

.
 It defines the irradiance vertical profile.
\end_layout

\begin_layout Subsection
FORCING_MANAGER
\family typewriter
 
\family default
(
\family typewriter
coupling/pom_forcing.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:FORCING_MANAGER"

\end_inset


\end_layout

\begin_layout Standard
This subroutine (called by 
\family typewriter
program main
\family default
, sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) handles the forcing data reading and interpolation.
 In its current formulation the subroutine is structured to accomodate perpetual
 year monthly forcing time series.
 A more general version has to be provided.
 The data currently handled are time series of monthly averaged data (see
 the description of subroutine
\family typewriter
 opendat,
\family default
 sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:opendat"

\end_inset

).
 The time series of the monthly averaged data is organised as follows: DEC
 - JAN - FEB - MAR - APR - MAY - JUN - JUL - AUG- SEP - OCT - NOV - DEC
 - JAN
\end_layout

\begin_layout Standard
fig.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:PyearForc-1"

\end_inset

 provides a schematic of the perpetual forcing timeline (
\family typewriter
ICOUNTF
\family default
 is the model counter for data readings and it is reset each time the end
 of file is reached).
\begin_inset VSpace defskip
\end_inset

 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename Figures/forcing_cyclical_time.png
	lyxscale 60

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Caption Standard

\begin_layout Plain Layout
Schematic of the forcing files structure and perpetual forcing timeline.
 ICOUNTF is the model counter for the data readings.
 It is reset each time the end of file is reached
\begin_inset CommandInset label
LatexCommand label
name "fig:PyearForc-1"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

The subroutine is essentially structured in three logical sections:
\end_layout

\begin_layout Itemize
initialisation and first forcing data readings
\end_layout

\begin_layout Itemize
linear time interpolation of the forcing data
\end_layout

\begin_layout Itemize
time update of the forcing data
\end_layout

\begin_layout Subsection*
Initialisation and first data readings
\end_layout

\begin_layout Standard
This section is entirely embedded into the 
\family typewriter
IF
\family default
 statement:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

 if(intt=INT(ONE)) then
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

 endif
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where 
\family typewriter
intt
\family default
 is the iteration index of the time marching loop (see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) counting the model iterations.
 The 
\family typewriter
IF
\family default
 statement ensures that the embedded statements are executed only once at
 the first model iteration.
 The following description is based on the implementation carried out in
 Mussap et al.
 
\begin_inset CommandInset citation
LatexCommand citeyearpar
key "mussap1,mussap3"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "mussap2"
literal "true"

\end_inset

.
 Obviously this section is open to custom modifications coeherent with the
 data structure that other users might have at hand.
\end_layout

\begin_layout Standard
The section start with the call to the subroutine 
\family typewriter
opendat
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:opendat"

\end_inset

), that operates the opening of the data files.
 Subsequently counters and parameters needed for the time linerar interpolation
 are initialised and defined:.
\end_layout

\begin_layout Standard

\family typewriter
ICOUNTF
\family default
 counts the data readings and it is initialised to 1.
\end_layout

\begin_layout Standard

\family typewriter
IFCHGE
\family default
 carries the number of model iterations needed to cover a 30 days period.
\end_layout

\begin_layout Standard

\family typewriter
IFINT
\family default
 progressively count the iterations.
 It is reset to zero in the interpolation section, when 
\family typewriter
IFINT=IFCHGE
\family default
.
 It is initialized at 
\family typewriter
(IFCHGE/2)-1
\family default
 because of the mid-month centered value assumption.
 
\end_layout

\begin_layout Standard
Afterward all the forcing data undergoes a double reading, allowing the
 system to load the two (monthly) data adjacent in time that are required
 to carry out the time linear interpolation.
 The update of the 
\family typewriter
ICOUNTF
\family default
 counter closes the initialization and first reading section.
\end_layout

\begin_layout Subsection*
Linear time interpolation of the forcing data
\end_layout

\begin_layout Standard
The time linear interpolation is carried out according to the general formula:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
D_{m}=D_{tf}+\theta_{f}(D_{tf+1}-D_{tf})\label{eq:Interpol}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset

Where 
\begin_inset Formula $D_{m}$
\end_inset

 is the interpolated forcing data to be provided to the model, 
\begin_inset Formula $D_{tf}$
\end_inset

 and 
\begin_inset Formula $D_{tf+1}$
\end_inset

 are the original forcing data adjacent in time and 
\begin_inset Formula $0\leq\theta_{f}\leq1$
\end_inset

 is the linear interpolator.
 
\begin_inset Formula $t_{f}$
\end_inset

 indicates the temporal sequence in the forcing data series.
 
\end_layout

\begin_layout Standard
The linear time interpolation section carries out the update of the 
\family typewriter
IFINT
\family default
 counter and the computation of the interpolator 
\family typewriter
RATIOF
\family default
 (
\begin_inset Formula $\theta_{f}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Interpol"

\end_inset

).
 
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

-----UPDATE INTERPOLATION COUNTER-----
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

      IFINT  = IFINT + INT(ONE)
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

-----UPDATE INTERPOLATOR-----
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

      RATIOF = FLOAT(IFINT)/FLOAT(IFCHGE)
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The linear time interpolation is carried out for each forcing scalar and
 array (wind stress, solar radiation, heat flux loss term, surface nutrients
 concentration, inorganic suspended matter, temperature and salinity profiles)
 as follows:
\end_layout

\begin_layout Standard
Scalars (only the procedure for the zonal wind stress components is shown,
 being identical for all the other forcing terms):
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

      WUSURF = WSU1 + RATIOF * (WSU2-WSU1)
\end_layout

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where, with respect to eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Interpol"

\end_inset


\family typewriter
 WUSURF
\family default
 corresponds to 
\begin_inset Formula $D_{m}$
\end_inset

, 
\family typewriter
WSU1
\family default
 and 
\family typewriter
WSU2
\family default
 correspond respectively to 
\begin_inset Formula $D_{tf}$
\end_inset

 and 
\begin_inset Formula $D_{tf+1}$
\end_inset

.
\end_layout

\begin_layout Standard
Arrays: The interpolated temperature and salinity profiles are initially
 loaded into the 
\family typewriter
TSTAR
\family default
 and 
\family typewriter
SSTAR
\family default
 arrays:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!     -----INTERPOLATE T&S PROFILES-----
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!       TSTAR(:) = TCLIM1(:) + RATIOF * (TCLIM2(:)-TCLIM1(:))       
\end_layout

\begin_layout Plain Layout

        SSTAR(:) = SCLIM1(:) + RATIOF * (SCLIM2(:)-SCLIM1(:))
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The inorganic suspended matter profiles (
\family typewriter
ISM
\family default
) are obtained with an interpolation procedure identical to the one described
 for temperature and salinity.
\end_layout

\begin_layout Subsection*
Time update of the forcing data
\end_layout

\begin_layout Standard
The last logical section of subroutine 
\family typewriter
FORCING_MANAGER
\family default
 handles the time dependent update (reading) of the forcing data.
 A data update is required each time that 
\family typewriter
IFINT=IFCHGE
\family default
.
 This activate all the statements that are embedded within the 
\family typewriter
IF 
\family default
statement:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!     -----BEGIN DATA UPDATE SECTION----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

     IF (IFINT==IFCHGE) THEN
\end_layout

\begin_layout Plain Layout

              .
\end_layout

\begin_layout Plain Layout

              .
\end_layout

\begin_layout Plain Layout

              .
\end_layout

\begin_layout Plain Layout

              .
\end_layout

\begin_layout Plain Layout

     ENDIF
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The update procedure require an update of the data reading counter (
\family typewriter
ICOUNTF
\family default
) and a reset of the iteration counter (
\family typewriter
IFINT
\family default
):
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!       -----....UPDATE MONTH COUNTER....----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

        ICOUNTF = ICOUNTF + 1 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!       -----....RESET INTERPOLATION COUNTER....----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

        IFINT   = INT(ZERO) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
after that, a shift in the forcing data is operated: 
\begin_inset Formula $D_{tf+1}$
\end_inset

 is transferred into 
\begin_inset Formula $D_{t}$
\end_inset

 (refer to eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Interpol"

\end_inset

).
 In the following is shown only the corresponding code procedure for the
 zonal wind stress and temperature, the procedure for other scalars and
 arrays being identical: 
\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!        -----....SHIFT THE MONTHLY DATA....----- !
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

         WSU1       = WSU2
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

         TCLIM1(:)  = TCLIM2(:)
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
A particular case occurs when the end of the forcing files is reached.
 In the current configuration this occurs when 
\family typewriter
ICOUNTF>13
\family default
.
 This condition activate the statements embedded into the IF statement:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!            -----IF 12 MONTHS HAVE GONE....
 ----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

             IF (ICOUNTF.GT.13) THEN
\end_layout

\begin_layout Plain Layout

                       .
\end_layout

\begin_layout Plain Layout

                       .
\end_layout

\begin_layout Plain Layout

                       .
\end_layout

\begin_layout Plain Layout

                       .
\end_layout

\begin_layout Plain Layout

             ENDIF
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
the data reading counter is reset:
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!            -----RESTART THE READING SEQUENCE----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

             ICOUNTF = 2
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
and the 
\begin_inset Formula $D_{tf}$
\end_inset

 data are read from the beginning of the file:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

             READ (11,REC=1) WSU1,WSV1 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

             DO K = 1,KB                 
\end_layout

\begin_layout Plain Layout

                READ (15,REC=K) TCLIM1(K)
\end_layout

\begin_layout Plain Layout

             END DO
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
and finally the 
\begin_inset Formula $D_{tf+1}$
\end_inset

 scalars and arrays are updated:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!        -----READ FOLLOWING MONTH----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

         READ (11,REC=ICOUNTF) WSU2,WSV2
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

         DO K = 1,KB              
\end_layout

\begin_layout Plain Layout

            READ (15,REC=(ICOUNTF-1)*KB+K) TCLIM2(K)          
\end_layout

\begin_layout Plain Layout

         END DO
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
It is reminded that every time the 
\begin_inset Formula $D_{tf}$
\end_inset

 and the 
\begin_inset Formula $D_{tf+1}$
\end_inset

 wind-stress and surface data are updated the conversion to the POM units
 is operated (change of sign included) e.g.:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!         -----WIND STRESS CONVERTED TO POM UNITS (N/m2-->m2/s2)----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

          WSU1 = -WSU1/RHO0           
\end_layout

\begin_layout Plain Layout

          WSV1 = -WSV1/RHO0
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!         -----HEAT FLUX CONVERTED TO POM UNITS(W/m2-->deg.C*m/s)----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

          SWRAD1  = -SWRAD1/rcp           
\end_layout

\begin_layout Plain Layout

          SWRAD2  = -SWRAD2/rcp
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
load_restart
\family typewriter
 
\family default
(
\family typewriter
coupling/pom_restart.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:load_restart"

\end_inset


\end_layout

\begin_layout Standard
This subroutine is called only if 
\family typewriter
IHOTST=1
\family default
 (secs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) and handles the opening and reading of the restart file for the POM component
 of the BFM-POM1D modeling system.
 The procedure require the opening and reading of the 
\family typewriter
pom_input
\family default
 namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "namelist-pom_input"

\end_inset

), that carries the path to the restart file.
 The open statement currently contained in the routine is corresponding
 to the unformatted restart writing contained in 
\family typewriter
program main
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

).
 Possible problems with the namelist opening and reading are flagged by
 a printed message operated by the BFM subroutine
\family typewriter
 error_msg_prn.
\end_layout

\begin_layout Subsection
get_init_TS_IC
\family typewriter
 
\family default
(
\family typewriter
coupling/pom_get_init_TS_IC.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:get-TS-IC"

\end_inset

 
\end_layout

\begin_layout Standard
When 
\family typewriter
IHOTST=0
\family default
 (see secs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

), 
\family typewriter
program
\family default
 
\family typewriter
main
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) calls this subroutine, that provides the initial temperature and salinity
 initial values needed for a 
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

start.
 As for subroutine
\family typewriter
 load_restart
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:load_restart"

\end_inset

) the path to the data files to be read is provided by the opening and reading
 of the 
\family typewriter
pom_input
\family default
 namelist (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "namelist-pom_input"

\end_inset

); after that, the files containing the initial 
\begin_inset Formula $T$
\end_inset

 and 
\begin_inset Formula $S$
\end_inset

 values are opened and read.
 The current 
\family typewriter
READ
\family default
 procedure embedded into the routine refers to the model implementation
 used by Mussap et al.
 
\begin_inset CommandInset citation
LatexCommand citeyearpar
key "mussap1,mussap3"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "mussap2"
literal "true"

\end_inset

, but obviously the initial conditions file reading is open to user modification.
 The subroutine operates only the loading of the initial Temperature and
 Salinity data in the state variables 
\family typewriter
T
\family default
, 
\family typewriter
TB
\family default
, 
\family typewriter
S
\family default
, and 
\family typewriter
SB
\family default
 (see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

) in order to comply with the model 
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

 start.
 Problems in the namelist opening and reading are flagged by the BFM 
\family typewriter
subroutine error_msg_prn.
\end_layout

\begin_layout Subsection
SCHEME_BENTHIC_LF1D
\family typewriter
 
\family default
(
\family typewriter
coupling/pom_scheme_benthic_lf1d.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec; SCHEME_BENTHIC_LF1D"

\end_inset


\end_layout

\begin_layout Standard
This subroutine is called by subroutine
\family typewriter
 pom_bfm_1d
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_bfm_1d"
plural "false"
caps "false"
noprefix "false"

\end_inset

); it carries out the the time integration of the BFM benthic (scalar) state
 variables using a leapfrog scheme.
 Input and output are handled by the 
\family typewriter
module POM
\family default
 and the BFM 
\family typewriter
module
\family default
s 
\family typewriter
api_BFM 
\family default
and 
\family typewriter
Mem.
\end_layout

\begin_layout Standard
The leapfrog integration is carried out according to eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:explicitLF-nosink"

\end_inset

, where, in this case, 
\begin_inset Formula $\widetilde{C}_{p}^{k+\frac{1}{2}}=\widetilde{C}_{p_{n+1}}^{k+\frac{1}{2}}$
\end_inset

 indicates the forward in time 
\begin_inset Formula $(t+\Delta t)$
\end_inset

 final solution for a scalar variable (stored in the temporary variable
 
\family typewriter
tempo)
\family default
 and 
\begin_inset Formula $C_{p_{n-1}}^{k}$
\end_inset

 the scalar variable at time 
\begin_inset Formula $t-\Delta t$
\end_inset

 , that is stored into the BFM variable 
\family typewriter
D2STATEB_BEN
\family default
.
\end_layout

\begin_layout Standard
The computed solution is eventually 
\begin_inset Quotes eld
\end_inset

clipped
\begin_inset Quotes erd
\end_inset

 if negative values are generated (unlikely case).
 In this case the forward in time solution is reset to a very low value:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!    -----CLIPPING (IF NEEDED....)----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

    do  n = 1,NO_D2_BOX_STATES_BEN 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

            tempo(n)=max(p_small,tempo(n)) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

    end do
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The Asselin filter (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Asselin"

\end_inset

) is then applied (using also the solution at time 
\begin_inset Formula $t$
\end_inset

, 
\family typewriter
D2STATEB_BEN
\family default
), and finally the time sequence is restored (see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_ini_BFM"

\end_inset

 for the definition of the 
\family typewriter
D2STATEB_BEN
\family default
 array).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!    -----RESTORE TIME SEQUENCE----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

     D2STATEB_BEN(:,1)=D2STATE_BEN(:,1)
\end_layout

\begin_layout Plain Layout

     D2STATE_BEN(:,1)=tempo(:) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsection

\lang british
opendat
\lang american
 (
\family typewriter
pom_opendat.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:opendat"

\end_inset


\end_layout

\begin_layout Standard
This subroutine provides the opening of all the data files needed for the
 model setup.
 The file data path is provided to the routine by the reading of the 
\family typewriter
namelist pom_input 
\family default
(sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "namelist-pom_input"

\end_inset

).
 In the subroutine version reported here (Mussap et al.
 
\begin_inset CommandInset citation
LatexCommand citeyear
key "mussap1,mussap3"
literal "true"

\end_inset

, 
\begin_inset CommandInset citation
LatexCommand citealp
key "mussap2"
literal "true"

\end_inset

) the open statements is referred to files that have been written in direct
 access mode.
 Oviously this is not mandatory.
 The structure of the input data file is open to user defined changes.
 Users must, however, make sure that the reading of the data in subroutines
 
\family typewriter
FORCING_MANAGER (
\family default
sec.

\family typewriter
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:FORCING_MANAGER"

\end_inset

),
\family default
 
\family typewriter
load_restart (
\family default
sec.
\family typewriter

\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:load_restart"

\end_inset

)
\family default
 and
\family typewriter
 get_init_TS_IC (
\family default
sec.
\family typewriter

\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:get-TS-IC"

\end_inset

)
\family default
 is consistent with the data file 
\family typewriter
access 
\family default
definition contained in the 
\family typewriter
open 
\family default
statement.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsection
pom_bfm_1d (
\family typewriter
coupling/pom_bfm_1d.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:pom_bfm_1d"

\end_inset


\end_layout

\begin_layout Standard
The BFM-POM1D coupling is entirely handled by this subroutine (called by
 
\family typewriter
program main
\family default
).
 It is structured as a simple sequential series of subroutine calls that
 perform:
\end_layout

\begin_layout Standard
The passage, from POM1D to BFM, of the information about the physical environmen
t (subroutine
\family typewriter
 pom_env_forcing_1d
\family default
, sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:env_forcing_pom_bfm_1"

\end_inset

).
\end_layout

\begin_layout Standard
The execution of the BFM core that computes the biogeochemistry dependent
 rate of change of all the BFM state variables.
 (BFM 
\family typewriter
subroutine EcologyDynamics
\family default
.
 See 
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

).
\end_layout

\begin_layout Standard
The computation of the physics dependent (vertical diffusion and sinking)
 rate of change for the BFM state variables, and the forward in time integration
 of the pelagic BFM state Variables, with source splitting coupling method
 and leapfrog numerical scheme (subroutine
\family typewriter
 vert_integration
\family default
, sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:vert_integration"

\end_inset

).
\end_layout

\begin_layout Standard
The forward in time integration of the benthic state variables with a leapfrog
 numerical scheme (subroutine
\family typewriter
 SCHEME_BENTHIC_LF1D
\family default
.
 see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec; SCHEME_BENTHIC_LF1D"

\end_inset

).
\end_layout

\begin_layout Standard
The handling of the model output (subroutine
\family typewriter
 pom_dia_bfm
\family default
., sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_dia_bfm"

\end_inset

).
\end_layout

\begin_layout Standard
The resetting of the BFM state variables trend arrays at the end of each
 time iteration (BFM subroutine
\family typewriter
 ResetFluxes.

\family default
 
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

).
\end_layout

\begin_layout Standard
Before the handling of the model output (call to subroutine
\family typewriter
 pom_dia_bfm
\family default
) the local variable 
\family typewriter
0<TT<savef
\family default
 (see secs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

and 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

) is updated.
 
\end_layout

\begin_layout Standard
The initialisation occurs at the first model iteration:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

       if(first) then 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

           TT=time-time0-(dti/SEC_IN_DAY)
\end_layout

\begin_layout Plain Layout

           out_delta=savef
\end_layout

\begin_layout Plain Layout

           first=.false.
 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

       endif
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

at each iteration 
\family typewriter
TT
\family default
 it is incremented by a 
\family typewriter
DTI/SEC_IN_DAY
\family default
 amount (The model time step converted in day fraction).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

       TT = TT + dti/SEC_IN_DAY 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\family typewriter
\begin_inset VSpace defskip
\end_inset

TT
\family default
 records the time (in days) elapsed between two adjacent output writings.
 It is passed as dummy argument to subroutine 
\family typewriter
pom_dia_bfm
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_dia_bfm"

\end_inset

) and, when 
\family typewriter
TT=savef+(DTI/SEC_IN_DAY
\family default
), the output data writing procedure is triggered.
\end_layout

\begin_layout Subsection
pom_dia_bfm 
\family typewriter
(coupling/pom_dia_bfm_1d.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:pom_dia_bfm"

\end_inset


\end_layout

\begin_layout Standard
This subroutine is called by subroutine 
\family typewriter
pom_bfm_1d
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_bfm_1d"

\end_inset

) and handles the time averaging and saving of the model output.
 The time frequency of the averaging and writing is set by the value of
 the 
\family typewriter
savef
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

) variable (expressed in hours).
 Its value is defined in the namelist 
\family typewriter
params_POMBFM
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

).
 The routine only dummy argument is the variable 
\family typewriter
TT
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_bfm_1d"

\end_inset

).
 The subroutines calls the BFM subroutine 
\family typewriter
calcmean_bfm
\family default
, (
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

) for output summation, averaging and writing).
\end_layout

\begin_layout Subsection
pom_ini_BFM 
\family typewriter
(coupling/pom_ini_bfm_1d.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:pom_ini_BFM"

\end_inset


\end_layout

\begin_layout Standard
This subroutine is called by 
\family typewriter
program main
\family default
 and ensures a BFM setup and state variable initialization consistent and
 coherent with the coupled 1D modelling system setup.
 All the requested input is managed trough modules.
 The BFM 1D array size is defined by the 
\family typewriter
KB
\family default
 value fixed in 
\family typewriter
module POM, 
\family default
sec.
 
\family typewriter

\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

.
\end_layout

\begin_layout Standard
It has to be noted that this routine originates from a modification of the
 3D version.
 Therefore the size of the (originally 3D) BFM arrays is shrunk to a 1D
 vector along the 
\begin_inset Quotes eld
\end_inset

vertical
\begin_inset Quotes erd
\end_inset

 (
\begin_inset Formula $z$
\end_inset

) dimension.
 Moreover, due to the vertical grid staggering (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Vgrid-1-1"

\end_inset

) the lowermost gridpoint (located at 
\family typewriter
K=KB
\family default
) is not used.
 Then the BFM arrays have dimension 
\family typewriter
(1, 1, kb-1)
\family default
: 
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "language=Fortran,basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!  ----SET THE BFM ARRAYS DIMENSION----- 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!  ****************************************************************************
\end_layout

\begin_layout Plain Layout

!  ****************************************************************************
\end_layout

\begin_layout Plain Layout

!  **                                                                  
      ** 
\end_layout

\begin_layout Plain Layout

!  ** SINCE THIS IS A 1D IMPLEMENTATION, THE SIZE OF THE ARRAYS IS SHRUNK
    **
\end_layout

\begin_layout Plain Layout

!  ** TO A 1D VECTOR  ALONG the "VERTICAL" DIMENSION.
 (1, 1, KB-1)           ** 
\end_layout

\begin_layout Plain Layout

!  **                                                                  
      ** 
\end_layout

\begin_layout Plain Layout

!  ****************************************************************************
 
\end_layout

\begin_layout Plain Layout

!  ****************************************************************************
 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

     NO_BOXES=KB-1      
\end_layout

\begin_layout Plain Layout

     NO_BOXES_X=1      
\end_layout

\begin_layout Plain Layout

     NO_BOXES_Y=1      
\end_layout

\begin_layout Plain Layout

     NO_BOXES_Z=NO_BOXES      
\end_layout

\begin_layout Plain Layout

     NO_BOXES_XY=1 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Detailed information on the BFM scalars defining the BFM arrays dimension
 can be found in 
\begin_inset CommandInset citation
LatexCommand citet
key "BFM-manual"
literal "true"

\end_inset

.
 However, below some basic information are repeated below:
\end_layout

\begin_layout Standard

\family typewriter
NO_BOXES
\family default
: Total number of grid points where coupled system solution must be computed
\end_layout

\begin_layout Standard

\family typewriter
NO_BOXES_Z
\family default
: vertical dimension of the arrays (in a 1D setup 
\family typewriter
NO_BOXES_Z=NO_BOXES
\family default
)
\end_layout

\begin_layout Standard

\family typewriter
NO_BOXES_XY
\family default
: Number of surface or bottom gridpoints (in a 1D setup 
\family typewriter
NO_BOXES_XY=1
\family default
 by definition).
\end_layout

\begin_layout Standard
The routine then define and initialize all the masks needed for the computation
 (in a 1D setup this is almost redundant, however), defines the total number
 of variables to be computed and initialize also the netcdf output files,
 trough the BFM (
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

) subroutines 
\family typewriter
set_var_info_bfm
\family default
, 
\family typewriter
init_var_bfm
\family default
 and 
\family typewriter
init_netcdf_bfm
\family default
 (all these operations do not need particular input from the user other
 than that defined by the namelists described above).
\end_layout

\begin_layout Standard
The BFM namelist 
\family typewriter
bfm_general 
\family default
(
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

) is read by the BFM subroutine 
\family typewriter
init_bfm
\family default
 that also write information about the setup in the simulation logfile.
 
\end_layout

\begin_layout Standard
The namelist
\family typewriter
 bfm_general
\family default
 contains also the variable 
\family typewriter
bfm_init
\family default
, that defines the simulation 
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

 (from initial conditions) or 
\begin_inset Quotes eld
\end_inset

hot
\begin_inset Quotes erd
\end_inset

 (from a restart file) start.
 In the BFM-POM1D setup the leading 
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

/
\begin_inset Quotes erd
\end_inset

hot
\begin_inset Quotes erd
\end_inset

 start flag is the parameter 
\family typewriter
IHOTST
\family default
, defined in the the module POM (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

), whose value is set in the namelist 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:pom_bfm_settings-namelist"

\end_inset

.
 Th
\family typewriter
e bfm_init
\family default
 value is then overwritten with the 
\family typewriter
IHOTST
\family default
 value:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!   ****************************************************************** 
\end_layout

\begin_layout Plain Layout

!   ****************************************************************** 
\end_layout

\begin_layout Plain Layout

!   **                                                              ** 
\end_layout

\begin_layout Plain Layout

!   ** FIX THE FLAG INDICATING THE "COLD"/"HOT" START               ** 
\end_layout

\begin_layout Plain Layout

!   **                                                              ** 
\end_layout

\begin_layout Plain Layout

!   ** N.B.: IN THE BFM-POM1D SETUP THE LEADING  "COLD"/'HOT"       ** 
\end_layout

\begin_layout Plain Layout

!   **       START FLAG IS IHOTST (DEFINED IN THE params_POMBFM     ** 
\end_layout

\begin_layout Plain Layout

!   **       NAMELIST).
                                             ** 
\end_layout

\begin_layout Plain Layout

!   **       THE bfm_init VALUE READ IN BFM_GENERAL IS OVERWRITTEN  ** 
\end_layout

\begin_layout Plain Layout

!   **       WITH THE IHOTST VALUE                                  ** 
\end_layout

\begin_layout Plain Layout

!   **                                                              ** 
\end_layout

\begin_layout Plain Layout

!   ****************************************************************** 
\end_layout

\begin_layout Plain Layout

!   ****************************************************************** 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

    bfm_init=ihotst 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The thickness of each model layers is computed from the fractional vertical
 coordinate (
\family typewriter
DZ
\family default
) and the bottom depth (
\family typewriter
H
\family default
) to be stored into the BFM array 
\family typewriter
Depth
\family default
:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!    -----SET THE THICKNESS OF THE WATER COLUMN LAYERS----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

    do k = 1 , NO_BOXES_Z
\end_layout

\begin_layout Plain Layout

       Depth(k) = dz(k)*h
\end_layout

\begin_layout Plain Layout

    end do 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
and then the output averaging and writing procedure is initialised trough
 a call to BFM subroutine 
\family typewriter
calcmean
\family default
.
 
\end_layout

\begin_layout Standard
This routine also takes care of the definition of the initial conditions
 for the BFM state variables.
 Initial conditions are defined in two steps.
 A very generic initialisation is carried out by mean of the BFM (
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

) subroutine
\family typewriter
 init_var_bfm
\family default
, where the BFM state variables are initialised at a spatially constant
 value.
 The initialisation is based on the carbon (
\begin_inset Formula $C$
\end_inset

) content values that are fed to the routine by the reading of the 
\family typewriter
namelist bfm.

\family default
 The initialisation is then completed by defining the nitrogen (
\begin_inset Formula $N$
\end_inset

), phosphorus (
\begin_inset Formula $P$
\end_inset

),and silicon (
\begin_inset Formula $Si$
\end_inset

) content by assuming a 
\begin_inset CommandInset citation
LatexCommand citet
key "Redfield63"
literal "true"

\end_inset

 
\begin_inset Formula $C:N:P$
\end_inset

 ratio, a 
\begin_inset CommandInset citation
LatexCommand citet
key "Richards58"
literal "true"

\end_inset

 
\begin_inset Formula $Si:P$
\end_inset

 ratio and on literature derived Chlorophyll to Carbon (
\begin_inset Formula $C:Chl)$
\end_inset

 ratio.
\end_layout

\begin_layout Standard
Such coarse and preliminary initialisation can be refined trough the use
 of 
\family typewriter
subroutine set_initial_conditions
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Subroutine-set_initial_condition"

\end_inset

) that can be customized by the user in order to provide (via hardwiring
 or data file reading) an initial conditions set more consistent with the
 specific implementation that is being defined.
\end_layout

\begin_layout Standard
The numerical integration method of choice for the BFM-POM1D system is the
 leapfrog scheme (see sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Info&Integr"

\end_inset

).
 The scheme requires to retain (at each time step 
\begin_inset Formula $t$
\end_inset

) the state variables solution at the previous time step 
\begin_inset Formula $\left(t-\Delta t\right)$
\end_inset

.
 For such time level, the values relative to the pelagic domain are stored
 in the array 
\family typewriter
D3STATEB
\family default
, while those relative to the benthic domain are stored in the array 
\family typewriter
D2STATEB_BEN
\family default
:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!  ******************************************************************* 
\end_layout

\begin_layout Plain Layout

!  ******************************************************************* 
\end_layout

\begin_layout Plain Layout

!  **                                                               ** 
\end_layout

\begin_layout Plain Layout

!  ** ALLOCATE AND INITIALISE  THE ARRAY TO BE LOADED WITH STATE    ** 
\end_layout

\begin_layout Plain Layout

!  ** VARIABLES (PELAGIC AND BENTHIC COMPUTED AT t=t-dt.
            ** 
\end_layout

\begin_layout Plain Layout

!  ** THIS IS NEEDED FOR THE LEAPGROG NUMERICAL INTEGRATION SCHEME  ** 
\end_layout

\begin_layout Plain Layout

!  ** USED BY THE BFM-POM1D SYSTEM                                  ** 
\end_layout

\begin_layout Plain Layout

!  **                                                               ** 
\end_layout

\begin_layout Plain Layout

!  ******************************************************************* 
\end_layout

\begin_layout Plain Layout

!  ******************************************************************* 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

   allocate(D3STATEB(NO_D3_BOX_STATES,NO_BOXES)) !PELAGIC 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!  -----ZEROING----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

   D3STATEB = ZERO 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

#ifdef INCLUDE_BEN 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

   allocate(D2STATEB_BEN(NO_D2_BOX_STATES_BEN,NO_BOXES_XY)) ! BENTHIC 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!  -----ZEROING----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

   D2STATEB_BEN = ZERO 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

#endif
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
In case of a 
\begin_inset Quotes eld
\end_inset

cold
\begin_inset Quotes erd
\end_inset

 start, the initial conditions are loaded in both the arrays corresponding
 to the 
\begin_inset Formula $t$
\end_inset

 (
\family typewriter
D3STATE, D2STATE_BEN
\family default
) and the 
\begin_inset Formula $t-\Delta t$
\end_inset

 (
\family typewriter
D2STATEB, D2STATEB_BEN
\family default
) time levels.
 More information on the structure pf the BFM arrays are provided in 
\begin_inset CommandInset citation
LatexCommand citet
key "BFM-manual"
literal "true"

\end_inset

.
 
\end_layout

\begin_layout Standard
Finally, the restart file is initialised and read based on the value of
 
\family typewriter
bfm_init (
\family default
calls to the BFM subroutines
\family typewriter
 init_netcdf_rst_bfm 
\family default
and
\family typewriter
 read_rst_bfm.
\end_layout

\begin_layout Subsection
pom_to_bfm 
\family typewriter
(phys/pom_to_bfm.F90
\family default
)
\begin_inset CommandInset label
LatexCommand label
name "subsec:pom_to_bfm"

\end_inset


\end_layout

\begin_layout Standard
This subroutine is (although very simple) an important element of the BFM-POM1D
 coupling, since it provides the transfer of the information about the physical
 environment towards BFM.
 Information transferred (temperature, salinity, density, inorganic suspended
 matter, surface shortwave radiation, wind velocity, bottom stress) is used
 to compute the biogeochemical rate of change (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Phys+bgc"

\end_inset

) of the BFM state variables.
\end_layout

\begin_layout Standard
Essentially the subroutine operate a simple data transfer between arrays,
 with the only difference of the wind velocity, that is (approximatively)
 computed back from the wind stress data assuming an air density values
 
\begin_inset Formula $\rho_{a}=1.25$
\end_inset

 and a drag coefficient 
\begin_inset Formula $1.40\cdot10^{-3}$
\end_inset

.
\end_layout

\begin_layout Standard
The correspondence between the 
\begin_inset Quotes eld
\end_inset

origin
\begin_inset Quotes erd
\end_inset

 and 
\begin_inset Quotes eld
\end_inset

destination
\begin_inset Quotes erd
\end_inset

 arrays involved in the transfer is summarized in tab.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:Array-to-array"

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="10" columns="4">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top" width="0pt">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Origin 
\end_layout

\end_inset
</cell>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Destination
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Property
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Array name and conversion algorithm
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Array name
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Units
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Potential Temperature
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
TB(k)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
ETW(k)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\textdegree C$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Salinity
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
SB(k)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
ESW(k)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $psu$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Density
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
[RHO(k)
\family default

\begin_inset Formula $\cdot10^{3}$
\end_inset

]+
\begin_inset Formula $rho0$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
ERHO(k)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $kg/m^{3}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Pressure
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
RHO(k)
\family default

\begin_inset Formula $\cdot g\cdot$
\end_inset


\family typewriter
ZZ(k)
\begin_inset Formula $\cdot$
\end_inset

H
\begin_inset Formula $\cdot10^{-5}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EPR(k)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $dbar$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Inorg.
 Susp Matter
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
ISM(k)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
ESS(k)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $mg/m^{3}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Radiance
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
-SWRAD
\family default

\begin_inset Formula $\cdot\left(\rho_{0}\cdot Cp\right)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EIR(1)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $W/m^{2}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Wind velocity
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
[(WUSURF
\begin_inset Formula $^{2}$
\end_inset

+WVSURF
\begin_inset Formula $^{2}$
\end_inset

)
\begin_inset Formula $^{0.5}/$
\end_inset


\begin_inset Formula $(\rho_{a}\cdot C_{d})$
\end_inset

]
\begin_inset Formula $^{0.5}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
EWIND
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $m/s$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Bottom Stress
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
(
\family typewriter
WUBOT
\family default

\begin_inset Formula $^{2}$
\end_inset

+
\family typewriter
WVBOT
\family default

\begin_inset Formula $^{2}$
\end_inset

)
\begin_inset Formula $^{0.5}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
ETAUB
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $N/m^{2}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Array to array transfer (and conversion algorithms) operated by 
\family typewriter
subroutine pom-to-bfm
\family default
.
\begin_inset CommandInset label
LatexCommand label
name "tab:Array-to-array"

\end_inset

 
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Subsection
PROFQ 
\family typewriter
(phys/profq1D.F90
\family default
)
\begin_inset Foot
status open

\begin_layout Plain Layout
Most of this section is taken from 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset


\end_layout

\end_inset


\begin_inset CommandInset label
LatexCommand label
name "subsec:PROFQ"

\end_inset


\end_layout

\begin_layout Standard
This is the 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor-Yamada82"
literal "true"

\end_inset

 2.5 turbulence closure model.
 It is called by 
\family typewriter
program main
\family default
.
 Its only dummy argument is twice the time step 
\family typewriter
DTI
\family default
.
 The other necessary input and the model output is managed trough modules.
\end_layout

\begin_layout Standard
This subroutine first solves for the vertical part of the equations 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Qeq"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:QLeq"

\end_inset

 for 
\begin_inset Formula $q_{2}$
\end_inset

 and 
\begin_inset Formula $q_{2}l$
\end_inset

.
 The solution is based on the implicit integration scheme (see eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:implicitLF"

\end_inset

) The numerical procedure is the same described for subroutine 
\family typewriter
PROF_TRACERS
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROF_TRACERS"

\end_inset

).
 A somewhat simplified version of the level 2.5 model is used here and is
 discussed in 
\begin_inset CommandInset citation
LatexCommand citet
key "Galperin88"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor89"
literal "true"

\end_inset

.
 The vertical diffusivities,
\family typewriter
 
\begin_inset Formula $K_{M}$
\end_inset


\family default
 and 
\begin_inset Formula $H_{H}$
\end_inset

, are defined according to:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
K_{\left(M,H\right)}=q_{2}lS_{\left(M,H\right)}
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The coefficients, 
\begin_inset Formula $S_{M}$
\end_inset

 and 
\begin_inset Formula $S_{H}$
\end_inset

, are functions of a Richardson number given by:
\begin_inset VSpace defskip
\end_inset


\begin_inset Formula 
\begin{equation}
S_{H}=\left[1-\left(3A_{2}B_{2}+18A_{1}A_{2}\right)G_{H}\right]=A_{2}\left[1-\frac{6A_{1}}{B_{1}}\right]\label{eq:SH}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
S_{M}=\left(1-9A_{1}A_{2}G_{H}\right)-9S_{H}A_{1}G_{H}\left(2A_{1}+A_{2}\right)=A_{1}\left(1-3C_{1}-\frac{6A_{1}}{B_{1}}\right)\label{eq:SM}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
G_{H}=\left(\frac{l}{q_{2}}\right)^{2}\frac{g}{\rho_{0}}\left(\frac{\partial\rho}{\partial z}-\frac{1}{C_{s}^{2}}\frac{\partial p}{\partial z}\right)\label{eq:GH}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
is a Richardson number.
 The five constants in eqs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:SH"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:SM"

\end_inset

 are mostly evaluated from near surface turbulence data (law-of-the-wall
 region) and are found 
\begin_inset CommandInset citation
LatexCommand citep
key "Mellor-Yamada82"
literal "true"

\end_inset

 to be 
\begin_inset Formula $\left(A_{1},B_{1},A_{2},B_{2,}C_{1}\right)=\left(0.92,16.6,0.74,10.1,0.08\right)$
\end_inset

.
 The stability functions limit to infinity as 
\begin_inset Formula $G_{H}$
\end_inset

 approaches the value, 0.0288, a value larger than one expects to find in
 nature.
 The quantity, 
\begin_inset Formula $C_{s}^{2}$
\end_inset

, in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:GH"

\end_inset

 is the speed of sound squared.
 The vertical pressure gradient is obtained from the hydrostatic relation,
 where the density is taken as a constant value consistent with the pressure
 determination in 
\family typewriter
subroutine DENS
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:DENS"

\end_inset

) i.e.
 
\begin_inset Formula $\partial p/\partial z=-\rho_{0}g.$
\end_inset


\end_layout

\begin_layout Subsection
PROF_TRACERS 
\family typewriter
(coupling/pom_profTrc.F90)
\begin_inset Foot
status open

\begin_layout Plain Layout
Most of this section is taken from 
\begin_inset CommandInset citation
LatexCommand citet
key "Mellor02"
literal "true"

\end_inset


\end_layout

\end_inset


\begin_inset CommandInset label
LatexCommand label
name "subsec:PROF_TRACERS"

\end_inset


\end_layout

\begin_layout Standard
This is a modification of the POM subroutine PROFT and solves for temperature,
 salinity and for the BFM state variables.
 It is called by 
\family typewriter
program main
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) in order to compute temperature and salinity, and by subroutine 
\family typewriter
vert_integration 
\family default
(sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:vert_integration"

\end_inset

) in order to compute the BFM state variables (in diagnostic mode, sec.
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Diagnostic-mode"

\end_inset

, the routine is used only for the computation of the BFM state variables).
 Its dummy arguments are:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
FF
\family default
: Property to be solved forward in time
\end_layout

\begin_layout Standard

\family typewriter
WFSURF
\family default
: Property surface flux (for temperature it lacks the incoming surface solar
 radiation)
\end_layout

\begin_layout Standard

\family typewriter
WFBOT
\family default
: Property bottom flux.
\end_layout

\begin_layout Standard

\family typewriter
SWRAD
\family default
: Incoming solar radiation (to be used only when prognostically computing
 temperature).
\end_layout

\begin_layout Standard

\family typewriter
FSURF:
\family default
 A prescribed surface value.
 
\end_layout

\begin_layout Standard

\family typewriter
NBC
\family default
: Flag for definition of the surface boundary condition.
\end_layout

\begin_layout Standard

\family typewriter
DT2
\family default
: Twice the Time step.
\end_layout

\begin_layout Standard

\family typewriter
NTP
\family default
: Flag to choose the optical (
\begin_inset CommandInset citation
LatexCommand citealp
key "Jerlov76"
literal "true"

\end_inset

) water type.
\end_layout

\begin_layout Standard

\family typewriter
UMOL
\family default
: Background diffusivity.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The implicit forward in time integration follows 
\begin_inset CommandInset citation
LatexCommand citet
key "Richtmeyer-Morton67"
literal "true"

\end_inset

.
 The method is used also to compute also 
\begin_inset Formula $u$
\end_inset

,
\begin_inset Formula $v,$
\end_inset

 
\begin_inset Formula $q_{2},$
\end_inset


\begin_inset Formula $q_{2}l$
\end_inset

(see secs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFQ"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROFUV"

\end_inset

).
\end_layout

\begin_layout Standard
In order to describe the solution procedure, eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:implicitLF"

\end_inset

 is written for temperature (the equation is then added of the radiation
 term appearing in eq.
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sigmaTemp"

\end_inset

).
 Solution for velocity components, salinity and BFM pelagic state variables
 can be obtained from the following by eliminating all the terms involving
 radiation.
 Note that the indexing used is consistent with fig.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Vgrid-1-1"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{align}
T_{n+1}^{k+\frac{1}{2}}-\widetilde{T}^{k+\frac{1}{2}}=\frac{2\Delta t}{H^{2}\Delta Z^{k}}\left[\left(K_{H}+\chi_{T}\right)_{n+1}^{k}\cdotp\left(\frac{T_{n+1}^{k-\frac{1}{2}}-T_{n+1}^{k+\frac{1}{2}}}{\Delta ZZ^{k-1}}\right)\right]-\nonumber \\
-\left[\left(K_{H}+\chi_{T}\right)_{n+1}^{k+1}\cdotp\left(\frac{T_{n+1}^{k+\frac{1}{2}}-T_{n+1}^{k+\frac{3}{2}}}{\Delta ZZ^{k+1}}\right)\right]-\frac{2\Delta t}{H\Delta Z^{k}}\left(R_{n+1}^{k-\frac{1}{2}}-R_{n+1}^{k+\frac{1}{2}}\right)\label{eq:Discdiff}
\end{align}

\end_inset


\end_layout

\begin_layout Standard
The above equation can be written as:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
-T_{p_{n+1}}^{k+\frac{3}{2}}a^{k}+T_{p_{n+1}}^{k+\frac{1}{2}}\left(a^{k}+c^{k}-1\right)-T_{n+1}^{k-\frac{1}{2}}c^{k}=d^{k}\label{eq:TdiffRewritten}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
a^{k}=-\frac{2\Delta t(K_{H}+\chi_{T})_{n+1}^{k+1}}{H^{2}\Delta Z^{k}\Delta ZZ^{k-1}}\label{eq:Aeq}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
c^{k}-\frac{2\Delta t(K_{H}++\chi_{T}^{h})_{n+1}}{\left(\Delta z^{k}\right)^{2}}\label{eq:Ceq}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
d^{k}=-\widetilde{T}^{k+\frac{1}{2}}+\frac{2\Delta t}{\Delta z^{k}}\left(RAD_{n+1}^{k-\frac{1}{2}}-RAD_{n+1}^{k+\frac{1}{2}}\right)\label{eq:Deq}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
assuming a solution of the form:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
T_{n+1}^{k+\frac{1}{2}}=VH_{k}\cdot T_{n+1}^{k+\frac{3}{2}}+VHP_{k}\label{eq:solF}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Inserting
\begin_inset Formula $T_{n+1}^{k+\frac{3}{2}}$
\end_inset

 directly from eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:solF"

\end_inset

 and 
\begin_inset Formula $T_{n+1}^{k-\frac{1}{2}}$
\end_inset

 ,obtained from eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:solF"

\end_inset

, into 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:TdiffRewritten"

\end_inset

 and collecting coefficients of 
\begin_inset Formula $T_{n+1}^{k-\frac{1}{2}}$
\end_inset

 and 1 yields:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
VH^{k}=\frac{a^{k}}{a^{k}+c^{k}\left(1-VH^{k-1}\right)-1}\label{eq:VHeq}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
VHP^{k}=\frac{c^{k}VHP^{k-1}+d^{k}}{a^{k}+c^{k}\left(1-VH^{k-1}\right)-1}\label{eq:VHPeq}
\end{equation}

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The solution is then as follows: All 
\begin_inset Formula $a_{k}$
\end_inset

, 
\begin_inset Formula $c_{k}$
\end_inset

 and 
\begin_inset Formula $d_{k}$
\end_inset

 terms are calculated from eqs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Aeq"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Ceq"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Deq"

\end_inset

.
 Surface boundary conditions, discussed below, provide 
\begin_inset Formula $VH_{1}$
\end_inset

 and 
\begin_inset Formula $VHP_{1}$
\end_inset

, all the necessary 
\begin_inset Formula $VH_{k}$
\end_inset

 and 
\begin_inset Formula $VHP_{k}$
\end_inset

 are obtained from the descending (as 
\begin_inset Formula $k$
\end_inset

 increases towards the bottom) recursive relations 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:VHeq"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:VHPeq"

\end_inset

.
 Bottom boundary conditions provide 
\begin_inset Formula $T_{n+1}^{kb-\frac{1}{2}}$
\end_inset

 where 
\begin_inset Formula $kb-\unitfrac{1}{2}$
\end_inset

 is the grid point nearest the bottom.
 Thereafter all of the 
\begin_inset Formula $T_{n+1}^{k+\frac{1}{2}}$
\end_inset

 may be obtained from the ascending recursive relation 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:solF"

\end_inset

.
\end_layout

\begin_layout Subsection*
The treatment of the short wave radiation.
\end_layout

\begin_layout Standard
The short wave radiation, is specified on the base of the optical water
 types classification proposed by 
\begin_inset CommandInset citation
LatexCommand citet
key "Jerlov76"
literal "true"

\end_inset

 as interpreted by 
\begin_inset CommandInset citation
LatexCommand citet
key "Paulson-Simpson77"
literal "true"

\end_inset

.
 Eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:doubleExp-1"

\end_inset

is then discretized as follows:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\textsf{\texttt{RAD=SWRAD[RPe^{\frac{Z_{k}H}{Ad_{1}}}+(1-RPe^{\frac{Z_{k}H}{Ad_{2}}})}]}
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
and the corresponding code in 
\family typewriter
subroutine PROF_TRACERS
\family default
 is:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!        *********************************************************** 
\end_layout

\begin_layout Plain Layout

!        *********************************************************** 
\end_layout

\begin_layout Plain Layout

!        **                                                       ** 
\end_layout

\begin_layout Plain Layout

!        ** PENETRATIVE RADIATION CALCULATION.
                    ** 
\end_layout

\begin_layout Plain Layout

!        ** AT THE BOTTOM ANY                                     ** 
\end_layout

\begin_layout Plain Layout

!        ** UNATTENUATED IS DEPOSITED IN THE BOTTOM LAYER         ** 
\end_layout

\begin_layout Plain Layout

!        **                                                       ** 
\end_layout

\begin_layout Plain Layout

!        *********************************************************** 
\end_layout

\begin_layout Plain Layout

!        *********************************************************** 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

         RAD(:) = SWRAD * ((    RP(NTP) * EXP(Z(:)*H/AD1(NTP))         
      &
\end_layout

\begin_layout Plain Layout

                        +  (ONE-RP(NTP) * EXP(Z(:)*H/AD2(NTP))))) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

         RAD(KB)=ZERO 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
where the partitioning factor 
\begin_inset Formula $RP$
\end_inset

 and the attenuation lengths 
\begin_inset Formula $Ad_{1}$
\end_inset

 and 
\begin_inset Formula $Ad_{2}$
\end_inset

 (respectively 
\begin_inset Formula $R$
\end_inset

, 
\begin_inset Formula $\varsigma_{1}$
\end_inset

 and 
\begin_inset Formula $\varsigma_{2}$
\end_inset

 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:doubleExp-1"

\end_inset

), are functions of the subroutine dummy argument NTP, that specifies the
 shortvawe transmission characteristics of each 
\begin_inset CommandInset citation
LatexCommand citet
key "Jerlov76"
literal "true"

\end_inset

 optical water type as summarized in table
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:JWtypes"

\end_inset

:
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="6">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
NTP
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
4
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
5
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset CommandInset citation
LatexCommand citet
key "Jerlov76"
literal "true"

\end_inset

 type
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
I
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Ia
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Ib
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
II
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
III
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
RP 
\family default
(
\begin_inset Formula $R_{p}$
\end_inset

)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
0.58
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
0.62
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
0.67
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
0.70
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
0.78
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
AD1
\family default
 (
\begin_inset Formula $\varsigma_{1}$
\end_inset

)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
0.35
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
0.60
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
1.0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
1.5
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
1.4
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
AD2
\family default
 (
\begin_inset Formula $\varsigma_{2}$
\end_inset

)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
23.0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
20.0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
17.0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
14.0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family typewriter
7.90
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
The 
\family typewriter
subroutine PROF_TRACERS 
\family default
parameters specifying the 
\begin_inset CommandInset citation
LatexCommand citet
key "Jerlov76"
literal "true"

\end_inset

 optical water types.
 Attenuations lengths AD1 and AD2 are from 
\begin_inset CommandInset citation
LatexCommand citet
key "Paulson-Simpson77"
literal "true"

\end_inset

.
\begin_inset CommandInset label
LatexCommand label
name "tab:JWtypes"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsection*
The surface boundary condition
\end_layout

\begin_layout Standard
Four different surface boundary conditions can be selected by choosing the
 appropriate 
\family typewriter
NBC
\family default
 parameter when calling 
\family typewriter
subroutine PROF_TRACERS
\family default
: 
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
NBC=1
\family default
 - Surface boundary conditions is 
\family typewriter
WFSURF
\family default
 .
 Here a surface flux (external forcing) is specified.
 This option can be used for all the state variables of the BFM-POM1D system.
 However, in case of the temperature boundary condition it has to be noted
 that the the dummy argument 
\family typewriter
WFSURF
\family default
 carries only the 
\begin_inset Formula $-\left[-\left(\varrho_{0}C_{p}\right)^{-1}\left(Q_{b}+Q_{e}+Q_{h}\right)\right]$
\end_inset

 components of the total heat flux eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "TBC"

\end_inset

).
 The short wave radiation term 
\begin_inset Formula $-\left(\varrho_{0}C_{p}\right)^{-1}Q_{s}$
\end_inset

 , in the same equation, is provided to the subroutine via the dummy argument
 
\family typewriter
SWRAD
\family default
.
 The composition of the total heat flux is carried out automatically by
 the subroutine (the vertical radiation profile 
\family typewriter
RAD
\family default
 is also set to zero):
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

      select case (NBC)
\end_layout

\begin_layout Plain Layout

         case (1)  
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

              VH(1)  =  A(1)/(A(1)-ONE)
\end_layout

\begin_layout Plain Layout

              VHP(1) = -DT2*(WFSURF+SWRAD)/(-DZ(1)*H) - FF(1)
\end_layout

\begin_layout Plain Layout

              VHP(1) =  VHP(1)/(A(1)-ONE) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

              RAD(:) = ZERO
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\begin_inset VSpace defskip
\end_inset

 It is recalled that the surface 
\begin_inset Quotes eld
\end_inset

virtual
\begin_inset Quotes erd
\end_inset

 salinity flux required for the salinity surface boundary condition (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:SBC"

\end_inset

) is computed in 
\family typewriter
program main
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

), while the surface flux for the BFM state variables (eqs.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NOSurflux"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NutSurflux"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:OSurflux"

\end_inset

) is computed in subroutine
\family typewriter
 vert_integration
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:vert_integration"

\end_inset

).
\end_layout

\begin_layout Standard

\family typewriter
NBC=2
\family default
 - This option is valid only for the treatment of the temperature.
 Surface boundary condition is WSSURF with SWRAD penetrating the water column
 as described in the previous paragraph
\family typewriter
.

\family default
 The corresponding code is:
\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

        case (2) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

              VH(1)  = A(1)/(A(1)-ONE)
\end_layout

\begin_layout Plain Layout

              VHP(1) = DT2*(WFSURF+RAD(1)-RAD(2))/(DZ(1)*H) -FF(1)
\end_layout

\begin_layout Plain Layout

              VHP(1) = VHP(1)/(A(1)-ONE)
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\family typewriter
NBC=3 
\family default
- Surface boundary condition is 
\family typewriter
FSURF
\family default
 (a prescribed surface value).
 This option can be used for all the state variables of the BFM-POM1D system.
\end_layout

\begin_layout Standard

\family typewriter
NBC=4
\family default
 - This option is valid only for the treatment of the temperature.
 Surface boundary condition is 
\family typewriter
TSURF
\family default
 and 
\family typewriter
SWRAD
\family default
 (a prescribed SST plus the short wave radiation penetration).
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The surface boundary conditions application can be described by writing
 eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Discdiff"

\end_inset

 for for 
\begin_inset Formula $k=\unitfrac{3}{2}$
\end_inset

 (as an example it is again proposed the temperature equation solution.
 For other state variables the radiation terms must be dropped:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
T_{n+1}^{\frac{3}{2}}-\widetilde{T}^{\frac{3}{2}}=-\frac{2\Delta t}{H^{2}\Delta Z^{1}}\left(WFSURF_{n+1}+RAD_{n+1}^{1}-RAD_{n+1}^{2}\right)-A_{1}\left(T_{n+1}^{\frac{3}{2}}-T_{n+1}^{\frac{5}{2}}\right)
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
using eq 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:solF"

\end_inset

to eliminate 
\begin_inset Formula $T_{n+1}^{\frac{5}{2}}$
\end_inset

 and collecting coefficients of 
\begin_inset Formula $T_{n+1}^{\frac{3}{2}}$
\end_inset

 and 
\begin_inset Formula $1$
\end_inset

 yields:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
VH^{1}=\frac{A^{1}}{A^{1}-1}
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
VHP^{k}=\frac{2\Delta t}{H\Delta Z^{1}}\left(WFSURF_{n+1}+RAD_{n+1}^{1}-RAD_{n+1}^{2}-\widetilde{T}^{\frac{3}{2}}\right)\left(\frac{1}{A^{1}-1}\right)
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Prescribing a surface value (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:TSBC"

\end_inset

) is much simpler since:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
VH^{1}=0
\]

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
VHP^{k}=T^{*}
\]

\end_inset


\end_layout

\begin_layout Paragraph*
The bottom boundary condition
\end_layout

\begin_layout Standard
An adiabatic bottom boundary condition can be obtained by setting the dummy
 argument 
\family typewriter
WFBOT=0
\family default
.
 A non-adiabatic bottom boundary condition (non-zero 
\family typewriter
WFBOT
\family default
, yet to be implemented) necessary for the BFM nutrients state variables
 (see eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NBenPelF"

\end_inset

) yields (repeating the above):
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
T_{n+1}^{km-\frac{1}{2}}=\frac{c^{km}-VHP^{km-1}-\widetilde{T}_{n+1}^{km-\frac{1}{2}}+\left(WFBOT+RAD_{km-1}-RAD_{km}\right)2\Delta t/\left(H\Delta Z^{km-1}\right)}{c^{km}\left(1-VH^{km-1}\right)-1}
\]

\end_inset


\end_layout

\begin_layout Subsection
PROFUV 
\family typewriter
(phys/profuv.F90)
\begin_inset CommandInset label
LatexCommand label
name "subsec:PROFUV"

\end_inset


\end_layout

\begin_layout Standard
This subroutine is called twice from 
\family typewriter
program main
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) and computes the vertical profiles of the velocity (zonal and meridional)
 components.
 The solution method applied is the one described for subroutine
\family typewriter
 PROF_TRACERS
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROF_TRACERS"

\end_inset

).
 The bottom boundary condition is, however, computed according to eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:BBC"

\end_inset

.
\end_layout

\begin_layout Standard
The subroutine dummy arguments are:
\family typewriter

\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard

\family typewriter
DT2
\family default
: Twice the time step
\end_layout

\begin_layout Standard

\family typewriter
VELF
\family default
: the velocity component to be computed
\end_layout

\begin_layout Standard

\family typewriter
SSTRESS
\family default
: the surface stress
\end_layout

\begin_layout Standard

\family typewriter
BSTRESS
\family default
: the bottom stress
\end_layout

\begin_layout Subsection
save_restart 
\family typewriter
(coupling/pom_restart.F90)
\end_layout

\begin_layout Standard
The subroutine is called by 
\family typewriter
program main
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:program-MAIN"

\end_inset

) after the completion of the time marching loop.
 It handles the writing of the restart file for the BFM.
 The routine simply calls the BFM subroutine
\family typewriter
 save_rst_bfm
\family default
 (see 
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

) after the conversion of the model time from days to seconds.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

! -----TIME ELLAPSED (IN SECONDS) SINCE THE BEGINNING OF THE SIMULATION----
 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

   localtime = time*SEC_PER_DAY    
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!-----WRITE RESTART----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

   call save_rst_bfm(localtime)        
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
vert_integration 
\family typewriter
(coupling/pom_vert_integration.F90)
\begin_inset CommandInset label
LatexCommand label
name "subsec:vert_integration"

\end_inset


\end_layout

\begin_layout Standard
This subroutine (called by 
\family typewriter
subroutine pom_bfm_1d,
\family default
 sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_bfm_1d"

\end_inset

) is the crucial one in the BFM-POM1D coupling procedure, as it computes
 the forward in time solution for the BFM pelagic state variables, accounting
 for the variation determined by both the physical and biogeochemical processes
 (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Phys+bgc"

\end_inset

).
 The subroutine receives the complete biogeochemical rate of change, as
 computed by the BFM core, and then proceeds to the time integration of
 eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:GeneqBFM"

\end_inset

), with a SoS numerical coupling technique, involving a semi implicit leapfrog
 numerical scheme as described in 
\begin_inset CommandInset citation
LatexCommand citet
key "butenschoen12"
literal "true"

\end_inset

.
\end_layout

\begin_layout Standard
The computer code consists essentially of a loop iterating over all the
 BFM pelagic state variables:
\begin_inset VSpace defskip
\end_inset


\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

    do m = 1 , NO_D3_BOX_STATES
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

           .
\end_layout

\begin_layout Plain Layout

    enddo
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
for each BFM pelagic state variable, the solution computed at time 
\begin_inset Formula $t$
\end_inset

 and 
\begin_inset Formula $t-\Delta t$
\end_inset

 is respectively transferred into the storage arrays 
\family typewriter
fbio
\family default
 and 
\family typewriter
ffbio 
\family default
from the master BFM arrays 
\family typewriter
D3STATE
\family default
 and 
\family typewriter
D3STATEB
\family default
 (
\begin_inset CommandInset citation
LatexCommand citealp
key "BFM-manual"
literal "true"

\end_inset

) and sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:pom_ini_BFM"

\end_inset

):
\begin_inset VSpace defskip
\end_inset


\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!         -----LOAD BFM STATE VAR.----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

          fbio(:)  = D3STATE(m,:)
\end_layout

\begin_layout Plain Layout

          fbbio(:) = D3STATEB(m,:) 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
After that, the surface boundary diffusive fluxes for the gases (oxygen
 and carbon dioxide) and nutrients (nitrate ammonium, phosphate, silicate)
 are stored into the 
\family typewriter
surflux
\family default
 and 
\family typewriter
botflux
\family default
 scalars:
\end_layout

\begin_layout Standard
for gases the surface boundary diffusive fluxes (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:OSurflux"

\end_inset

) are computed by specific BFM procedures, see sec 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:The-BFMboundary-conditions"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "BFM-manual"
literal "true"

\end_inset

, while the surface diffusive boundary flux for nutrients is computed by
 applying the relaxation procedure of eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NutSurflux"

\end_inset

, involving a prescribed climatological, time varying surface nutrient concentra
tion (
\begin_inset Formula $N^{*}$
\end_inset

) and a user defined relaxation velocity.
\end_layout

\begin_layout Standard
At the bottom, the gases and nutrient diffusive fluxes at the water-sediment
 interface are are both computed in the BFM 
\family typewriter
subroutine BenthicReturn1Dynamics
\family default
 according to eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:NBenPelF"

\end_inset

 and inserted into the biogeochemical rate of change trough a procedure
 handled by the BFM core.
 The variable botflux is therefore set to zero, but future version of the
 code will use the bottom diffusive flux as a bottom boundary condition.
 
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!                -----OXYGEN----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                 case (ppO2o) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                       surflux = -(jsurO2o(1)/SEC_PER_DAY) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                       botflux = ZERO 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\begin_layout Plain Layout

!                -----PHOSPHATE---- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                 case (ppN1p) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                      surflux = -(PO4SURF-n1p(1))*vrelax 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                      botflux = ZERO 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
All the other BFM pelagic state variables have a nil surface and bottom
 diffusive flux.
\end_layout

\begin_layout Standard
After that, the subroutine proceed to store, into the array 
\family typewriter
sink
\family default
, the sinking velocity 
\begin_inset Formula $(w_{s})$
\end_inset

, converted from 
\begin_inset Formula $m/d$
\end_inset

 to 
\begin_inset Formula $m/s$
\end_inset

 for the particulate organic matter and phytoplankton functional groups.
 It is recalled that the particulate organic matter sinking velocity is
 vertically constant, and is user defined trough an assignment to the BFM
 parameter 
\family typewriter
p_rR6m,
\family default
 contained in the namelist 
\family typewriter
PelGlobal_parameters.

\family default
 the phytoplankton sinking velocity (if any) is vertically variable in dependenc
e of the nutrient stress status and depends on the BFM parameters p_res
 and p_esNI (see 
\begin_inset CommandInset citation
LatexCommand citet
key "BFM-manual"
literal "true"

\end_inset

).
 The sinking velocity at the water sediment interface is imposed to correspond
 to the burial velocity 
\begin_inset Formula $w_{b}$
\end_inset

 in order to comply with the bottom boundary condition 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:burial flux"

\end_inset

.
 The 
\begin_inset Formula $w_{b}$
\end_inset

 value for (respectively) the particulate organic matter and the phytoplankton
 is user defined trough an assignment to the BFM parameters 
\family typewriter
p_burvel_R6
\family default
 and 
\family typewriter
p_burvePI
\family default
 contained in the 
\family typewriter
Settling_parameters 
\family default
namelist.
 As an example below it is shown the full procedure for the definition of
 the particulate organic matter sinking velocity.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!         ********************************************* 
\end_layout

\begin_layout Plain Layout

!         ********************************************* 
\end_layout

\begin_layout Plain Layout

!         **                                         ** 
\end_layout

\begin_layout Plain Layout

!         ** Computing sedimentation fluxes          ** 
\end_layout

\begin_layout Plain Layout

!         **                                         ** 
\end_layout

\begin_layout Plain Layout

!         ********************************************* 
\end_layout

\begin_layout Plain Layout

!         ********************************************* 
\end_layout

\begin_layout Plain Layout

!           select case ( m ) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!                -----PARTICULATE ORGANIC MATTER----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                 case (ppR6c:ppR6s) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                       do k = 1 , KB - 1 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                          sink(k) = -sediR6(k)/SEC_PER_DAY 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                       end do 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!                      *********************************************** 
\end_layout

\begin_layout Plain Layout

!                      *********************************************** 
\end_layout

\begin_layout Plain Layout

!                      **                                           ** 
\end_layout

\begin_layout Plain Layout

!                      ** Set the  Particulate organic matter       ** 
\end_layout

\begin_layout Plain Layout

!                      ** sinking velocity (burial velocity) at the ** 
\end_layout

\begin_layout Plain Layout

!                      ** water-sediment interface.
                 ** 
\end_layout

\begin_layout Plain Layout

!                      **                                           ** 
\end_layout

\begin_layout Plain Layout

!                      *********************************************** 
\end_layout

\begin_layout Plain Layout

!                      *********************************************** 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

                       sink(kb)=-p_burvel_R6/SEC_PER_DAY
\end_layout

\begin_layout Plain Layout

                       if(ABS(sink(kb-1)).lt.ABS(sink(kb))) &
\end_layout

\begin_layout Plain Layout

                       sink(kb) = sink(kb-1) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
For all the non-sinking BFM pelagic state variables the 
\family typewriter
sink
\family default
 array is initialised at zero.
\end_layout

\begin_layout Standard
The following step is the definition of the vertical advection (sinking)
 flux, computed according to eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:sinking"

\end_inset

.
 This occur trough a call to the subroutine
\family typewriter
 adverte
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:adverte"

\end_inset

).
 Note that this subroutine is called for all the BFM pelagic state variables
 (sinking and non sinking).
 However the 
\family typewriter
sink(:)=0
\family default
 assignment for the non sinking state variables ensures that the output
 sinking flux (stored in array 
\family typewriter
ffbio
\family default
) is nil.
\end_layout

\begin_layout Standard
The source splitting forward in time integration (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Info&Integr"

\end_inset

) of the BFM pelagic state variables can be now performed.
 The first step is the execution of an explicit leapfrog integration involving
 the sinking (if any) and the biogeochemical rate of change.
 For the non sinking state variables the integration is carried out according
 to eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:explicitLF-nosink"

\end_inset

, while for the sinking state variables it follows eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:explicitLF-sink"

\end_inset

.
 The intermediate value arising from this explicit integration is stored
 into the array 
\family typewriter
ffbio:
\family default
and passed to the 
\family typewriter
subroutine PROF_TRACERS 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PROF_TRACERS"

\end_inset


\family default
 that conclude the computation of the forward in time solution, trough an
 implicit integration accounting for the vertical diffusion processes acting
 on the state variables.
\end_layout

\begin_layout Standard
The (almost) final solution (stored in the array 
\family typewriter
ffbio
\family default
) is checked for (unlikely) negative concentration values trough a 
\begin_inset Quotes eld
\end_inset

clipping
\begin_inset Quotes erd
\end_inset

 procedure:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!     -----CLIPPING......IF NEEDED----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

      do k=1, KB-1 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

            ffbio(k)=max(p_small,ffbio(k)) 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

      end do 
\end_layout

\begin_layout Plain Layout

! 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

In such case the solution is set to a very small value.
\end_layout

\begin_layout Standard
The solution is then effectively finalised trough the 
\begin_inset CommandInset citation
LatexCommand citet
key "Asselin72"
literal "true"

\end_inset

 filtering.
 The storage of the solutions at the relevant time levels is then stored
 back into the master arrays 
\family typewriter
D3STATE
\family default
 and 
\family typewriter
D3STATEB
\family default
:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\tiny}"
inline false
status open

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!    ---MIX SOLUTIONS AND RESTORE TIME SEQUENCE----- 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

     do n = 1, KB-1 
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

      D3STATEB(m,n)=fbio(n)+0.5_RLEN*smoth*(ffbio(n)+ fbbio(n)-2.0_RLEN*fbio(n))
\end_layout

\begin_layout Plain Layout

      D3STATE(m,n)=ffbio(n)
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

     end do
\end_layout

\end_inset


\end_layout

\begin_layout Section
BFM-POM1D setup and control namelists 
\begin_inset CommandInset label
LatexCommand label
name "sec:pom_bfm_settings-namelist"

\end_inset


\end_layout

\begin_layout Standard
The 
\family typewriter
pom_bfm_settings.nml
\family default
 file is a container for the two main namelists that control the BFM-POM1D
 setup (
\family typewriter
Params_POMBFM
\family default
) and initial conditions and external forcings (
\family typewriter
pom_input
\family default
).
\end_layout

\begin_layout Standard
The namelist 
\family typewriter
Params_POMBFM
\family default
 is read in the 
\family typewriter
MAIN
\family default
 program and provides all the values for the variables that define the code
 setup and control.
 All of them are stored into 
\family typewriter
module POM
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:modulePOM"

\end_inset

) or module 
\family typewriter
service
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:moduleService"

\end_inset

).
 Below the namelist set for the implementation used in Mussap et al.
 
\begin_inset CommandInset citation
LatexCommand citeyearpar
key "mussap1,mussap3"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "mussap2"
literal "true"

\end_inset

 is reported as an example.
\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "language=Fortran,basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! NAMELIST params_POMBFM
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

! NAME                  [UNIT]/KIND       DESCRIPTION 
\end_layout

\begin_layout Plain Layout

! H                         [m]           Depth 
\end_layout

\begin_layout Plain Layout

! DTI                       [s]           Timestep 
\end_layout

\begin_layout Plain Layout

! ALAT                      [degrees]     Latitude 
\end_layout

\begin_layout Plain Layout

! IDIAGN                    legacy, the runs are now only diagnostic
\end_layout

\begin_layout Plain Layout

! IDAYS                     [d]           Length of run 
\end_layout

\begin_layout Plain Layout

! SMOTH                     [-]           Parameter for Hasselin filter
 
\end_layout

\begin_layout Plain Layout

! IHOTST                    [-]           1 = Restart reading 
\end_layout

\begin_layout Plain Layout

!                                         0 = Cold start 
\end_layout

\begin_layout Plain Layout

! KL1 & KL2                 [-]           Establish Surface/bottom logarithmic
 layers distribution 
\end_layout

\begin_layout Plain Layout

!                                         KL1: Surface logarithmic distribution.
 The numers of layers is KL1-2 
\end_layout

\begin_layout Plain Layout

!                                         KL2: Bottom logarithic distribution.
 The numers of layers is KB-KL2-1 
\end_layout

\begin_layout Plain Layout

! SAVEF                     [d]           Saving frequency (days) 
\end_layout

\begin_layout Plain Layout

! NRT                       [m/d]         Relaxation constant for nutrients
 at surface
\end_layout

\begin_layout Plain Layout

! NBCT, NBCS, NBCBFM        [-]           Define surface boundary conditions
 for temperature, salinity & BFM tracers !                             
            NBC = 1: Surf.
 B.C.
 is WFSURF.
 no radiative penetration 
\end_layout

\begin_layout Plain Layout

!                                         NBC = 2; Surf.
 B.C.
 is WFSURF+SWRAD*(1.-TR).
 with SWRAD*TR penetration 
\end_layout

\begin_layout Plain Layout

!                                         NBC = 3; Surf.
 B.C.
 is TSURF.
 no SW radiative penetration 
\end_layout

\begin_layout Plain Layout

! UMOL                      [m^2/s]       Background diffusion for momentum
 
\end_layout

\begin_layout Plain Layout

! UMOLT, UMOLS,UMOLBFM      [m^2/s]       Background diffusion for T,S and
 BFM tracers 
\end_layout

\begin_layout Plain Layout

! NTP                       [-]           Flag for Jerlov water type 
\end_layout

\begin_layout Plain Layout

!                                         NTP =               1      2 
      3       4       5 
\end_layout

\begin_layout Plain Layout

!                                         JERLOV TYPE   =     I      IA
      IB      II      III 
\end_layout

\begin_layout Plain Layout

! TRT,SRT                   [ ]           Relaxation time for t & S lateral
 advection 
\end_layout

\begin_layout Plain Layout

! upperh                    [m]           Depth at which lat eadv start
 
\end_layout

\begin_layout Plain Layout

! SSRT                      [m/d]         Relaxation time for surface salinity
 flux 
\end_layout

\begin_layout Plain Layout

! CBCMIN                                  Minimum achievable bottom drag
 coeff 
\end_layout

\begin_layout Plain Layout

! Z0B                                     Bottom roughness length
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

!  &Params_POMBFM  
\end_layout

\begin_layout Plain Layout

H       =  16.,  
\end_layout

\begin_layout Plain Layout

DTI     =  100.,  
\end_layout

\begin_layout Plain Layout

ALAT    =  45.,  
\end_layout

\begin_layout Plain Layout

IDIAGN  =  1,  
\end_layout

\begin_layout Plain Layout

IDAYS   =  3600,  
\end_layout

\begin_layout Plain Layout

SMOTH   =  0.1,  
\end_layout

\begin_layout Plain Layout

IHOTST  =  0,  
\end_layout

\begin_layout Plain Layout

KL1     =  7,  
\end_layout

\begin_layout Plain Layout

KL2     =  25,  
\end_layout

\begin_layout Plain Layout

SAVEF   =  30,  
\end_layout

\begin_layout Plain Layout

NRT     =  0.2,  
\end_layout

\begin_layout Plain Layout

NBCT    =  2,  
\end_layout

\begin_layout Plain Layout

NBCS    =  1,  
\end_layout

\begin_layout Plain Layout

NBCBFM  =  1,  
\end_layout

\begin_layout Plain Layout

UMOL    =  2.e-5,  
\end_layout

\begin_layout Plain Layout

UMOLT   =  1.e-5,  
\end_layout

\begin_layout Plain Layout

UMOLS   =  1.3e-6,  
\end_layout

\begin_layout Plain Layout

UMOLBFM =  2.e-5,  
\end_layout

\begin_layout Plain Layout

NTP     =  2,  
\end_layout

\begin_layout Plain Layout

TRT     =  0,  
\end_layout

\begin_layout Plain Layout

SRT     =  1,  
\end_layout

\begin_layout Plain Layout

UPPERH  =  5.0,  
\end_layout

\begin_layout Plain Layout

SSRT    =  5.68    
\end_layout

\begin_layout Plain Layout

/
\end_layout

\end_inset


\end_layout

\begin_layout Standard
This namelist
\family typewriter
 pom_input
\family default
 is read three times: in subroutine 
\family typewriter
FORCING_MANAGER (
\family default
sec.

\family typewriter
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:FORCING_MANAGER"

\end_inset

), 
\family default
subroutine
\family typewriter
 get_init_TS_IC 
\family default
(sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:get_init_TS_IC"

\end_inset

) and
\family typewriter
 
\family default
subroutine
\family typewriter
 load_restart
\family default
 (sec.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:load_restart"

\end_inset

).
 It provides the directory paths to all the data files (surface forcing,
 prescribed 
\begin_inset Formula $T$
\end_inset

, 
\begin_inset Formula $S$
\end_inset

, inorganic suspended sediment vertical profiles and surface nutrient concentrat
ion values) to be read by the coupled system.
 The example below is again taken from the BFM-POM1D implementation of Mussap
 et.
 al.
 
\begin_inset CommandInset citation
LatexCommand citeyearpar
key "mussap1,mussap3"
literal "true"

\end_inset

, 
\begin_inset CommandInset citation
LatexCommand citet
key "mussap2"
literal "true"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "language=Fortran,basicstyle={\tiny\ttfamily}"
inline false
status open

\begin_layout Plain Layout

! NAMELIST: pom_input
\end_layout

\begin_layout Plain Layout

! -----DEFINE PATH TO DATA FILES-------
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

! NAME             [UNIT]/KIND       DESCRIPTION 
\end_layout

\begin_layout Plain Layout

! wind_input         [N/m^2]         U and V components of surface wind
 stress 
\end_layout

\begin_layout Plain Layout

! heat_input         [W/m^2]         Total heat flux 
\end_layout

\begin_layout Plain Layout

! surfNut_input    [BFM units]       surface nutrient inputs (NO3,NH4,PO4,SIO4)
 
\end_layout

\begin_layout Plain Layout

! Sprofile_input       [-]           Salinity Initial Condition 
\end_layout

\begin_layout Plain Layout

! Tprofile_input     [degC]          Water temperature Initial Condition
 
\end_layout

\begin_layout Plain Layout

! ism_input            [-]           Inorganic Suspended Matter monthly
 climatology 
\end_layout

\begin_layout Plain Layout

! Sal_input            [-]           Salinity monthly climatology 
\end_layout

\begin_layout Plain Layout

! Temp_input           [-]           Water temperature monthly climatology
 
\end_layout

\begin_layout Plain Layout

! read_restart         char          Filename of input restart file for
 POM
\end_layout

\begin_layout Plain Layout

!
\end_layout

\begin_layout Plain Layout

&pom_input 
\end_layout

\begin_layout Plain Layout

wind_input      =  '/input/windstress_mon_Mussap.da', 
\end_layout

\begin_layout Plain Layout

surfaceS_input  =  '/input/Ssurf_16m.da', 
\end_layout

\begin_layout Plain Layout

radiance_input  =  '/input/radiance_daily_Mussap.da', 
\end_layout

\begin_layout Plain Layout

ism_input       =  '/input/ISM_16m_Mussap.da', 
\end_layout

\begin_layout Plain Layout

Sal_input       =  '/input/ClimaS_MA21_16m.da', 
\end_layout

\begin_layout Plain Layout

Temp_input      =  '/input/ClimaT_MA21_16m.da', 
\end_layout

\begin_layout Plain Layout

Sprofile_input  =  '/input/Sinit_16m.da', 
\end_layout

\begin_layout Plain Layout

Tprofile_input  =  '/input/Tinit_16m.da', 
\end_layout

\begin_layout Plain Layout

heat_input      =  '/input/heatflux.da', 
\end_layout

\begin_layout Plain Layout

surfNut_input   =  '/input/NutrientsARPAOGS.da', 
\end_layout

\begin_layout Plain Layout

read_restart    =  '/input/fort.70' 
\end_layout

\begin_layout Plain Layout

/
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Running BFM_POM1D
\end_layout

\begin_layout Section
Description
\end_layout

\begin_layout Standard
The BFM_POM1D configuration is based on the work carried out by 
\begin_inset CommandInset citation
LatexCommand citet
key "mussap1"
literal "true"

\end_inset

, 
\begin_inset CommandInset citation
LatexCommand citet
key "mussap2"
literal "true"

\end_inset

 and 
\begin_inset CommandInset citation
LatexCommand citet
key "mussap3"
literal "true"

\end_inset

 and it represent the evolution of biogeochemical processes in the middle
 of the Gulf of Trieste (Italy).
 The default configuration is a 10 years long simulation of a water column
 located in the centre of the gulf driven by climatological forcing conditions,
 with the prescription of seawater temperature and salinity profiles using
 the diagnostic mode (see details in section 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Diagnostic-mode"

\end_inset

).
 All the input files are contained in the configuration folder BFM_POM1D
 and the reader is referred to the papers quoted above for details, as well
 for the selected parameterizations and settings.
\end_layout

\begin_layout Section
Execute the model
\end_layout

\begin_layout Standard
Code compilation and deployment of the model is done automatically by the
 script 
\emph on
bfm_configure.sh
\emph default
 (see the BFM core manual for its usage and environment setup) by using
 the following command
\end_layout

\begin_layout Standard

\family typewriter
\emph on
$> ./bfm_configure.sh -gcd -p BFM_POM1D
\end_layout

\begin_layout Standard
Once that model setup is completed go the run folder (
\family typewriter
${BFMDIR}/run/bfm_pom1d
\family default
) and launch the executable
\end_layout

\begin_layout Standard

\family typewriter
\emph on
$> ./bfm_pom.exe
\end_layout

\begin_layout Standard
The model will perform a 10 year long simulation saving output data every
 30 days (see also description of 
\family typewriter
Params_POMBFM
\family default
 namelist).
\end_layout

\begin_layout Section
Results
\end_layout

\begin_layout Standard
As illustrated in 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:BFM-POM1D-Trieste"
plural "false"
caps "false"
noprefix "false"

\end_inset

, the configuration simulates the coupled physical and biogeochemical dynamics
 in the gulf of Trieste with a winter peak of phytoplankton that occurs
 along the entire water column and a progressive deepening of biological
 activity during the summer stratified conditions.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
A
\begin_inset Graphics
	filename Figures/bfm_pom1d/p-pel-N1p.png
	lyxscale 30
	scale 50

\end_inset

B
\begin_inset Graphics
	filename Figures/bfm_pom1d/l-pel-Chla.png
	lyxscale 30
	scale 50

\end_inset


\end_layout

\begin_layout Plain Layout
\align center
C
\begin_inset Graphics
	filename Figures/bfm_pom1d/c-pel-Z5c.png
	lyxscale 30
	scale 50

\end_inset

D
\begin_inset Graphics
	filename Figures/bfm_pom1d/c-pel-Z4c.png
	lyxscale 30
	scale 50

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
BFM-POM1D implementation in the Gulf of Trieste.
 Climatological annual cycles computed over the last 5 years of simulation
 for A) Phosphate (
\begin_inset Formula $mmolP/m^{3})$
\end_inset

, B) Chlorophyll (
\begin_inset Formula $mg/m^{3}),$
\end_inset

 C) Microzooplankton (
\begin_inset Formula $mgC/m^{3})$
\end_inset

, D) Omnivorous zooplankton (
\begin_inset Formula $mgC/m^{3})$
\end_inset

.
\begin_inset CommandInset label
LatexCommand label
name "fig:BFM-POM1D-Trieste"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard

\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
twocolumn
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Newpage cleardoublepage
\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset bibtex
LatexCommand bibtex
bibfiles "bfm-pom-references"
options "bibtotoc,elsart-harv"

\end_inset


\end_layout

\end_body
\end_document
